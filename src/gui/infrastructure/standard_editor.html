<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ë¶èÁØÑ JSON Á∑®ËºØÂô®</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: #18181b; /* Zinc 950 */
                color: #e4e4e7; /* Zinc 200 */
                min-height: 100vh;
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #18181b;
            }
            ::-webkit-scrollbar-thumb {
                background: #3f3f46;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #52525b;
            }

            /* Header */
            .header {
                background: #27272a; /* Zinc 900 */
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #3f3f46; /* Zinc 700 */
            }
            .header h1 {
                font-size: 1.3rem;
                color: #fff;
            }
            .header-buttons {
                display: flex;
                gap: 10px;
            }
            .header-info {
                display: flex;
                align-items: center;
                gap: 15px;
                flex: 1;
                margin-left: 20px;
            }
            .header-info .info-item {
                font-size: 0.85rem;
                color: #888;
            }
            .header-info .info-value {
                color: #60a5fa; /* Blue 400 */
                font-weight: 500;
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
                font-weight: 500;
            }
            .btn-primary {
                background: transparent;
                border: 1px solid #3b82f6; /* Blue 500 */
                color: #60a5fa; /* Blue 400 */
                box-shadow: none;
            }
            .btn-primary:hover {
                background: rgba(59, 130, 246, 0.1); /* Blue 500 with opacity */
                border-color: #60a5fa; /* Blue 400 */
                transform: translateY(-1px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            .btn-secondary {
                background: transparent;
                color: #e4e4e7;
                border: 1px solid #3f3f46; /* Zinc 700 */
            }
            .btn-secondary:hover {
                background: rgba(255, 255, 255, 0.05);
                border-color: #52525b; /* Zinc 600 */
            }
            .btn-danger {
                background: transparent;
                border: 1px solid #ef4444; /* Red 500 */
                color: #f87171; /* Red 400 */
            }
            .btn-danger:hover {
                background: rgba(239, 68, 68, 0.1);
                border-color: #f87171;
            }

            /* Tabs */
            .tabs {
                display: flex;
                background: #27272a; /* Zinc 900 */
                border-bottom: 1px solid #3f3f46;
            }
            .tab {
                padding: 12px 24px;
                cursor: pointer;
                border-bottom: 2px solid transparent;
                transition: all 0.2s;
                color: #a1a1aa; /* Zinc 400 */
            }
            .tab:hover {
                color: #e4e4e7;
                background: #3f3f46;
            }
            .tab.active {
                color: #60a5fa; /* Blue 400 */
                border-bottom-color: #6366f1; /* Indigo 500 */
                background: #18181b; /* Seamless match with content */
            }

            /* Tab Content */
            .tab-content {
                display: none;
                height: calc(100vh - 120px);
                overflow: hidden;
            }
            .tab-content.active {
                display: flex;
            }

            /* Tab 1 & 2: Simple Form */
            .form-container {
                padding: 30px;
                width: 100%;
                overflow-y: auto;
            }
            .form-group {
                margin-bottom: 20px;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #aaa;
                font-size: 0.9rem;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                max-width: 500px;
                padding: 10px 12px;
                border: 1px solid #3f3f46; /* Zinc 700 */
                border-radius: 6px;
                background: #18181b; /* Darker input bg */
                color: #fff;
                font-size: 1rem;
            }
            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #3b82f6; /* Blue 500 */
                box-shadow: 0 0 0 1px #3b82f6;
            }

            /* Meta Schema Table */
            .schema-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .schema-table th,
            .schema-table td {
                padding: 10px;
                text-align: left;
                border-bottom: 1px solid #3f3f46; /* Zinc 700 */
            }
            .schema-table th {
                color: #888;
                font-weight: 500;
                font-size: 0.85rem;
            }
            .schema-table input,
            .schema-table select {
                width: 100%;
                padding: 6px 8px;
                border: 1px solid #3f3f46; /* Zinc 700 */
                border-radius: 4px;
                background: #18181b; /* Zinc 950 */
                color: #fff;
                font-size: 0.9rem;
            }
            .schema-table input[type="checkbox"] {
                width: auto;
            }
            /* Fix dropdown options visibility in dark theme */
            /* Fix dropdown options visibility in dark theme */
            select option {
                background: #18181b;
                color: #e4e4e7;
            }

            /* Schema Group Styles */
            .schema-group {
                background: #27272a; /* Zinc 900 */
                border: 1px solid #3f3f46; /* Zinc 700 */
                border-radius: 8px;
                margin-bottom: 20px;
                overflow: hidden;
            }
            .schema-group-header {
                background: #27272a; /* Zinc 900 */
                padding: 12px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #3f3f46;
            }
            .schema-group-header input {
                background: transparent;
                border: 1px solid transparent; /* Hidden unless focused */
                border-radius: 4px;
                padding: 6px 10px;
                color: #fff;
                font-size: 1rem;
                font-weight: 500;
                flex: 1;
                max-width: 300px;
            }
            .schema-group-header input:hover {
                border-color: #3f3f46;
            }
            .schema-group-header input:focus {
                outline: none;
                background: #18181b;
                border-color: #3b82f6;
            }
            .schema-group-header .group-actions {
                display: flex;
                gap: 8px;
            }
            .schema-group-body {
                padding: 15px;
            }
            .schema-group.dragging {
                opacity: 0.4;
                background: rgba(59, 130, 246, 0.1); /* Blue tint */
            }
            .schema-group.drag-over {
                border: 2px dashed #3b82f6; /* Blue 500 */
            }

            /* Drag handle */
            .drag-handle {
                cursor: grab;
                padding: 5px 10px;
                color: #666;
                user-select: none;
                font-size: 1.2rem;
            }
            .drag-handle:active {
                cursor: grabbing;
            }
            .schema-table tr.dragging {
                opacity: 0.4;
                background: rgba(99, 102, 241, 0.1);
            }
            /* drag-over removed to avoid double visual indicators */
            .schema-table tr.drag-placeholder {
                background: rgba(59, 130, 246, 0.05);
                border: 2px dashed #3b82f6;
            }
            .schema-table tr.drag-placeholder td {
                background: rgba(59, 130, 246, 0.05); /* Unified background */
            }
            .drag-ghost {
                position: fixed;
                pointer-events: none;
                z-index: 9999;
                opacity: 0.95;
                background: #27272a; /* Zinc 900 */
                border: 1px solid #2563eb; /* Blue 600 */
                box-shadow:
                    0 10px 15px -3px rgba(0, 0, 0, 0.5),
                    0 4px 6px -2px rgba(0, 0, 0, 0.1);
                border-radius: 4px;
                display: table; /* Maintain table layout */
                width: auto;
            }
            .drag-ghost td {
                padding: 8px; /* Match table cell padding */
                border-bottom: none;
            }
            /* Ensure inputs in ghost element maintain styles */
            .drag-ghost input,
            .drag-ghost select {
                width: 100%;
                padding: 6px 8px;
                border: 1px solid #3f3f46;
                border-radius: 4px;
                background: #18181b; /* Zinc 950 */
                color: #fff;
                font-size: 0.9rem;
            }
            .schema-table tbody tr {
                transition:
                    transform 0.15s ease,
                    opacity 0.15s ease;
            }

            /* Options Sidebar */
            .options-sidebar {
                position: fixed;
                top: 0;
                right: -350px;
                width: 350px;
                height: 100%;
                background: #18181b;
                border-left: 1px solid #3f3f46;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                transition: right 0.3s ease;
            }
            .options-sidebar.open {
                right: 0;
            }
            .options-sidebar-header {
                padding: 20px;
                border-bottom: 1px solid #3f3f46;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .options-sidebar-header h3 {
                font-size: 1rem;
                color: #e4e4e7;
                margin: 0;
            }
            .options-sidebar-header .close-btn {
                background: transparent;
                border: none;
                color: #71717a;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 4px 8px;
            }
            .options-sidebar-header .close-btn:hover {
                color: #fff;
            }
            .options-sidebar-content {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            .options-sidebar-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .option-item {
                background: #27272a;
                border-radius: 8px;
                padding: 12px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .option-item .drag-handle {
                cursor: grab;
                color: #52525b;
                font-size: 1rem;
                user-select: none;
            }
            .option-item .drag-handle:active {
                cursor: grabbing;
            }
            .option-item .inputs {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .option-item input {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #3f3f46;
                border-radius: 4px;
                background: #18181b;
                color: #fff;
                font-size: 0.85rem;
            }
            .option-item input:focus {
                outline: none;
                border-color: #3b82f6;
            }
            .option-item input.error {
                border-color: #ef4444;
            }
            .option-item .delete-btn {
                background: transparent;
                border: 1px solid #3f3f46;
                border-radius: 4px;
                color: #a1a1aa;
                padding: 6px 10px;
                cursor: pointer;
            }
            .option-item .delete-btn:hover {
                background: rgba(239, 68, 68, 0.2);
                border-color: #ef4444;
                color: #f87171;
            }
            .option-item.dragging {
                opacity: 0.5;
                background: #3f3f46;
            }
            .option-item.drag-over {
                border-top: 2px solid #3b82f6;
            }
            .options-sidebar-footer {
                padding: 15px 20px;
                border-top: 1px solid #3f3f46;
            }
            .options-sidebar-footer button {
                width: 100%;
                padding: 10px;
                background: transparent;
                border: 1px solid #3b82f6;
                color: #60a5fa;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .options-sidebar-footer button:hover {
                background: rgba(59, 130, 246, 0.1);
            }
            /* Push main content when sidebar open */
            #tab-schema.sidebar-open .form-container {
                margin-right: 350px;
                transition: margin-right 0.3s ease;
            }
            .edit-options-btn {
                padding: 3px 8px;
                font-size: 0.75rem;
                background: transparent;
                border: 1px solid #3b82f6;
                color: #60a5fa;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 8px;
            }
            .edit-options-btn:hover {
                background: rgba(59, 130, 246, 0.1);
            }
            /* Tab 3: Two Column Layout */
            .two-column {
                display: flex;
                width: 100%;
                height: 100%;
            }

            /* Sidebar */
            .sidebar {
                width: 280px;
                background: #18181b;
                border-right: 1px solid #3f3f46;
                overflow-y: auto;
                flex-shrink: 0;
            }
            .sidebar-header {
                padding: 15px;
                border-bottom: 1px solid #3f3f46;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .sidebar-header h3 {
                font-size: 0.9rem;
                color: #a1a1aa;
            }
            .section-item {
                border-bottom: 1px solid #27272a;
            }
            .section-header {
                padding: 12px 15px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background 0.2s;
                justify-content: space-between;
                background: #27272a;
            }
            .section-header .section-info {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }
            .section-header .delete-btn {
                opacity: 0;
                padding: 2px 6px;
                font-size: 0.75rem;
                background: rgba(220, 53, 69, 0.8);
                border: none;
                border-radius: 4px;
                color: #fff;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .section-header:hover .delete-btn {
                opacity: 1;
            }
            .section-header:hover {
                background: #3f3f46;
            }
            .section-header.active {
                background: rgba(59, 130, 246, 0.1);
                color: #60a5fa;
            }
            .section-header .arrow {
                transition: transform 0.2s;
                color: #666;
            }
            .section-header.expanded .arrow {
                transform: rotate(90deg);
            }
            .section-items {
                display: none;
                background: rgba(0, 0, 0, 0.2);
            }
            .section-items.expanded {
                display: block;
            }
            .item-entry {
                padding: 10px 15px 10px 35px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #aaa;
                transition: all 0.2s;
            }
            .item-entry:hover {
                background: #27272a;
                color: #fff;
            }
            .item-entry.active {
                background: rgba(59, 130, 246, 0.15);
                color: #60a5fa;
                border-right: 2px solid #3b82f6;
            }

            /* Editor Panel */
            .editor-panel {
                flex: 1;
                padding: 20px 30px;
                overflow-y: auto;
            }
            .editor-panel h2 {
                font-size: 1.2rem;
                margin-bottom: 20px;
                color: #e4e4e7; /* Zinc 200 */
            }
            .editor-section {
                background: #27272a; /* Zinc 900 */
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
            }
            .editor-section h3 {
                font-size: 1rem;
                color: #a1a1aa; /* Zinc 400 */
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #3f3f46;
            }
            .editor-row {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
            }
            .editor-row .form-group {
                flex: 1;
                margin-bottom: 0;
            }
            .editor-row .form-group.small {
                flex: 0 0 120px;
            }
            textarea {
                width: 100%;
                min-height: 100px;
                padding: 10px 12px;
                border: 1px solid #3f3f46;
                border-radius: 6px;
                background: #18181b; /* Zinc 950 */
                color: #fff;
                font-size: 0.95rem;
                resize: vertical;
                font-family: inherit;
            }
            textarea:focus {
                outline: none;
                border-color: #3b82f6; /* Blue 500 */
                box-shadow: 0 0 0 1px #3b82f6;
            }

            /* Checklist Preview */
            .checklist-preview {
                background: #18181b;
                border-radius: 6px;
                padding: 15px;
                margin-top: 10px;
                border: 1px solid #3f3f46;
            }
            .checklist-preview h4 {
                font-size: 0.85rem;
                color: #a1a1aa; /* Zinc 400 */
                margin-bottom: 10px;
            }
            .checklist-item {
                padding: 8px 0;
                border-bottom: 1px solid #27272a;
                font-size: 0.9rem;
                color: #d4d4d8; /* Zinc 300 */
            }
            .checklist-item:last-child {
                border-bottom: none;
            }
            .checklist-item .id {
                color: #60a5fa; /* Blue 400 */
                margin-right: 8px;
            }

            /* Checkbox Group */
            .checkbox-group {
                display: flex;
                gap: 20px;
            }
            .checkbox-group label {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                color: #d4d4d8; /* Zinc 300 */
            }

            /* Action Buttons */
            .action-buttons {
                display: flex;
                gap: 10px;
                margin-top: 20px;
            }

            /* Empty State */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #71717a; /* Zinc 500 */
            }
            .empty-state .icon {
                font-size: 3rem;
                margin-bottom: 15px;
                color: #52525b; /* Zinc 600 */
            }

            /* Hidden file input */
            #file-input {
                display: none;
            }
        </style>
    </head>
    <body>
        <input type="file" id="file-input" accept=".json" />

        <div class="header">
            <h1>üìã Ë¶èÁØÑ JSON Á∑®ËºØÂô®</h1>
            <div class="header-info">
                <span class="info-item"
                    >Ë¶èÁØÑ:
                    <span class="info-value" id="header-standard-name"
                        >-</span
                    ></span
                >
                <span class="info-item"
                    >Ê™îÊ°à:
                    <span class="info-value" id="header-filename"
                        >(Êú™ÂåØÂÖ•)</span
                    ></span
                >
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="importJSON()">
                    üì• ÂåØÂÖ• JSON
                </button>
                <button class="btn btn-primary" onclick="exportJSON()">
                    üì§ ÂåØÂá∫ JSON
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    üóëÔ∏è Ê∏ÖÁ©∫
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="info">üìÑ Ë¶èÁØÑË≥áË®ä</div>
            <div class="tab" data-tab="schema">üìã Â∞àÊ°àÊ¨Ñ‰Ωç</div>
            <div class="tab" data-tab="standards">üìÅ Ê∏¨Ë©¶Ê®ôÊ∫ñ</div>
        </div>

        <!-- Tab 1: Ë¶èÁØÑË≥áË®ä -->
        <div id="tab-info" class="tab-content active">
            <div class="form-container">
                <div class="form-group">
                    <label>Ë¶èÁØÑÂêçÁ®±</label>
                    <input
                        type="text"
                        id="standard_name"
                        placeholder="‰æãÔºöÈÅôÊéßÁÑ°‰∫∫Ê©üË≥áÂÆâÊ™¢Ê∏¨Ë¶èÁØÑ_v1.0"
                        oninput="
                            data.standard_name = this.value;
                            updateHeaderInfo();
                        "
                    />
                </div>
                <div class="form-group">
                    <label>Ë¶èÁØÑÁâàÊú¨</label>
                    <input
                        type="text"
                        id="standard_version"
                        placeholder="‰æãÔºöMODA_1.0"
                    />
                </div>
                <div class="form-group">
                    <label>È†êË®≠Âà§ÂÆöÁâàÊú¨ (Êñ∞Â¢ûÊ∏¨È†ÖÊôÇËá™ÂãïÂ•óÁî®)</label>
                    <input
                        type="text"
                        id="default_criteria_version"
                        placeholder="‰æãÔºöMODA_v1.0"
                    />
                </div>
            </div>
        </div>

        <!-- Tab 2: Â∞àÊ°àÊ¨Ñ‰Ωç -->
        <div id="tab-schema" class="tab-content">
            <div class="form-container">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    "
                >
                    <div>
                        <h2 style="margin: 0">
                            Â∞àÊ°àÊ¨Ñ‰ΩçË®≠ÂÆö (project_meta_schema)
                        </h2>
                        <p style="color: #888; margin: 5px 0 0 0">
                            ÂÆöÁæ©Âª∫Á´ãÂ∞àÊ°àÊôÇÈúÄË¶ÅÂ°´ÂØ´ÁöÑÊ¨Ñ‰ΩçÔºåÊ¨Ñ‰ΩçÊúÉ‰æùÁæ§ÁµÑÂàÜÈ°ûÈ°ØÁ§∫
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="addSchemaGroup()">
                        + Êñ∞Â¢ûÁæ§ÁµÑ
                    </button>
                </div>

                <div id="schema-groups-container"></div>
            </div>

            <!-- Options Sidebar -->
            <div class="options-sidebar" id="options-sidebar">
                <div class="options-sidebar-header">
                    <h3 id="options-sidebar-title">Á∑®ËºØÈÅ∏È†Ö</h3>
                    <button class="close-btn" onclick="closeOptionsSidebar()">
                        √ó
                    </button>
                </div>
                <div class="options-sidebar-content">
                    <div class="options-sidebar-list" id="options-list"></div>
                </div>
                <div class="options-sidebar-footer">
                    <button onclick="addOptionToSidebar()">+ Êñ∞Â¢ûÈÅ∏È†Ö</button>
                </div>
            </div>
        </div>

        <!-- Tab 3: Ê∏¨Ë©¶Ê®ôÊ∫ñ -->
        <div id="tab-standards" class="tab-content">
            <div class="two-column">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h3>üìÇ Á´†ÁØÄÁµêÊßã</h3>
                        <button
                            class="btn btn-secondary"
                            style="padding: 4px 8px; font-size: 0.8rem"
                            onclick="addSection()"
                        >
                            + Á´†ÁØÄ
                        </button>
                    </div>
                    <div id="sidebar-tree">
                        <div class="empty-state" style="padding: 40px">
                            <div>Â∞öÁÑ°Á´†ÁØÄ</div>
                        </div>
                    </div>
                </div>

                <!-- Editor Panel -->
                <div class="editor-panel" id="editor-panel">
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <div>Ë´ãÂæûÂ∑¶ÂÅ¥ÈÅ∏ÊìáÁ´†ÁØÄÊàñÊ∏¨È†ÖÈÄ≤Ë°åÁ∑®ËºØ</div>
                        <div style="margin-top: 10px; font-size: 0.9rem">
                            ÊàñÈªûÊìä„Äå+ Á´†ÁØÄ„ÄçÊñ∞Â¢û
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ===== ÂÖ®ÂüüË≥áÊñô =====
            let data = {
                standard_name: "",
                standard_version: "",
                default_criteria_version: "MODA_v1.0",
                project_meta_schema: [],
                test_standards: [],
            };

            let currentEditType = null; // 'section' or 'item'
            let currentEditIndex = null; // section index
            let currentEditItemIndex = null; // item index within section
            let currentFilename = null;

            function updateHeaderInfo() {
                document.getElementById("header-standard-name").textContent =
                    data.standard_name || "-";
                document.getElementById("header-filename").textContent =
                    currentFilename || "(Êú™ÂåØÂÖ•)";
            }

            // ===== Tab ÂàáÊèõ =====
            document.querySelectorAll(".tab").forEach((tab) => {
                tab.addEventListener("click", () => {
                    document
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    document
                        .querySelectorAll(".tab-content")
                        .forEach((c) => c.classList.remove("active"));
                    tab.classList.add("active");
                    document
                        .getElementById("tab-" + tab.dataset.tab)
                        .classList.add("active");
                });
            });

            // ===== ÂåØÂÖ•/ÂåØÂá∫ =====
            function importJSON() {
                document.getElementById("file-input").click();
            }

            document
                .getElementById("file-input")
                .addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        try {
                            let content = evt.target.result;
                            // ÁßªÈô§ BOM
                            if (content.charCodeAt(0) === 0xfeff) {
                                content = content.slice(1);
                            }
                            try {
                                const json = JSON.parse(content);
                                data.standard_name = json.standard_name || "";
                                data.standard_version =
                                    json.standard_version || "";
                                data.project_meta_schema =
                                    json.project_meta_schema || [];
                                data.test_standards = json.test_standards || [];
                            } catch (e) {
                                alert(
                                    `JSON Ëß£ÊûêÂ§±Êïó: ${e.message}\n` +
                                        `‰ΩçÁΩÆ: ${e.at || "Êú™Áü•"}\n` +
                                        `Ââç 50 Â≠óÂÖÉ: ${content.substring(
                                            0,
                                            50,
                                        )}\n` +
                                        `Èï∑Â∫¶: ${content.length}`,
                                );
                                return;
                            }

                            document.getElementById("standard_name").value =
                                data.standard_name;
                            document.getElementById("standard_version").value =
                                data.standard_version;

                            renderSchemaTable();
                            renderSidebar();
                            clearEditor();
                            currentFilename = file.name;
                            updateHeaderInfo();
                            alert("ÂåØÂÖ•ÊàêÂäüÔºÅ");
                        } catch (err) {
                            alert("JSON Ëß£ÊûêÂ§±ÊïóÔºö" + err.message);
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = "";
                });

            // Header Inputs Auto-save
            [
                "standard_name",
                "standard_version",
                "default_criteria_version",
            ].forEach((id) => {
                document
                    .getElementById(id)
                    ?.addEventListener("input", saveToLocalStorage);
            });

            const STORAGE_KEY = "TEST_STANDARD_EDITOR_DATA";
            const STORAGE_FILENAME_KEY = "TEST_STANDARD_EDITOR_FILENAME";

            function saveToLocalStorage() {
                try {
                    // Sync header fields to data before saving
                    data.standard_name =
                        document.getElementById("standard_name")?.value || "";
                    data.standard_version =
                        document.getElementById("standard_version")?.value ||
                        "";
                    data.default_criteria_version =
                        document.getElementById("default_criteria_version")
                            ?.value || "MODA_v1.0";

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    if (currentFilename) {
                        localStorage.setItem(
                            STORAGE_FILENAME_KEY,
                            currentFilename,
                        );
                    }
                } catch (e) {
                    console.error("Failed to save to localStorage", e);
                }
            }

            function loadFromLocalStorage() {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    const storedFilename =
                        localStorage.getItem(STORAGE_FILENAME_KEY);

                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        if (
                            parsedData &&
                            Array.isArray(parsedData.test_standards)
                        ) {
                            data.standard_name = parsedData.standard_name || "";
                            data.standard_version =
                                parsedData.standard_version || "";
                            data.project_meta_schema =
                                parsedData.project_meta_schema || [];
                            data.test_standards =
                                parsedData.test_standards || [];
                            data.default_criteria_version =
                                parsedData.default_criteria_version ||
                                "MODA_v1.0";

                            if (storedFilename)
                                currentFilename = storedFilename;

                            document.getElementById("standard_name").value =
                                data.standard_name;
                            document.getElementById("standard_version").value =
                                data.standard_version;
                            const verEl = document.getElementById(
                                "default_criteria_version",
                            );
                            if (verEl)
                                verEl.value = data.default_criteria_version;

                            updateHeaderInfo();
                            renderSchemaTable();
                            renderSidebar();
                            console.log("Loaded data from localStorage");
                        }
                    }
                } catch (e) {
                    console.error("Failed to load from localStorage", e);
                }
            }

            function exportJSON() {
                // È©óË≠â project_meta_schema
                const errors = [];
                data.project_meta_schema.forEach((group, gIdx) => {
                    if (!group.group_label || !group.group_label.trim()) {
                        errors.push(`Áæ§ÁµÑ ${gIdx + 1}ÔºöÁæ§ÁµÑÂêçÁ®±Êú™Â°´ÂØ´`);
                    }
                    if (!group.fields || group.fields.length === 0) {
                        errors.push(
                            `Áæ§ÁµÑ„Äå${group.group_label || "Êú™ÂëΩÂêç"}„ÄçÔºöÁæ§ÁµÑÂÖßÊ≤íÊúâ‰ªª‰ΩïÊ¨Ñ‰Ωç`,
                        );
                    }
                    (group.fields || []).forEach((field, fIdx) => {
                        if (!field.key || !field.key.trim()) {
                            errors.push(
                                `Áæ§ÁµÑ„Äå${group.group_label || "Êú™ÂëΩÂêç"}„ÄçÊ¨Ñ‰Ωç ${fIdx + 1}ÔºöKey Êú™Â°´ÂØ´`,
                            );
                        }
                        if (!field.label || !field.label.trim()) {
                            errors.push(
                                `Áæ§ÁµÑ„Äå${group.group_label || "Êú™ÂëΩÂêç"}„ÄçÊ¨Ñ‰Ωç ${fIdx + 1}ÔºöLabel Êú™Â°´ÂØ´`,
                            );
                        }
                    });
                });

                if (errors.length > 0) {
                    alert("Ë´ãÊ™¢Êü•‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö\n\n" + errors.join("\n"));
                    return;
                }

                // Êî∂ÈõÜË≥áÊñô
                data.standard_name =
                    document.getElementById("standard_name").value;
                data.standard_version =
                    document.getElementById("standard_version").value;
                data.default_criteria_version = document.getElementById(
                    "default_criteria_version",
                ).value;

                const output = {
                    standard_name: data.standard_name,
                    standard_version: data.standard_version,
                    default_criteria_version: data.default_criteria_version,
                    project_meta_schema: data.project_meta_schema,
                    test_standards: data.test_standards,
                };

                const blob = new Blob([JSON.stringify(output, null, 4)], {
                    type: "application/json",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = currentFilename || "standard_config.json";
                a.click();
                URL.revokeObjectURL(url);
            }

            function clearAll() {
                if (!confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâË≥áÊñôÂóéÔºü")) return;
                data = {
                    standard_name: "",
                    standard_version: "",
                    default_criteria_version: "MODA_v1.0",
                    project_meta_schema: [],
                    test_standards: [],
                };
                currentFilename = ""; // Clear filename
                document.getElementById("standard_name").value = "";
                document.getElementById("standard_version").value = "";
                document.getElementById("default_criteria_version").value =
                    "MODA_v1.0";
                renderSchemaTable();
                renderSidebar();
                clearEditor();
                updateHeaderInfo(); // Update header after clearing
                localStorage.removeItem(STORAGE_KEY); // Clear local storage
                localStorage.removeItem(STORAGE_FILENAME_KEY); // Clear local storage filename
            }

            // ÂàùÂßãÂåñÊôÇÂòóË©¶ËÆÄÂèñ
            window.addEventListener("DOMContentLoaded", loadFromLocalStorage);

            // ===== Schema Groups =====
            let dragSrcGroupIdx = null;
            let dragSrcFieldIdx = null;

            function renderSchemaTable() {
                const container = document.getElementById(
                    "schema-groups-container",
                );

                if (
                    !data.project_meta_schema ||
                    data.project_meta_schema.length === 0
                ) {
                    container.innerHTML =
                        '<div class="empty-state" style="padding:40px;"><div>Â∞öÁÑ°Áæ§ÁµÑÔºåÈªûÊìä„Äå+ Êñ∞Â¢ûÁæ§ÁµÑ„ÄçÈñãÂßã</div></div>';
                    return;
                }

                container.innerHTML = data.project_meta_schema
                    .map(
                        (group, gIdx) => `
                    <div class="schema-group" data-group-idx="${gIdx}">
                        <div class="schema-group-header">
                            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                                <div style="display:flex; flex-direction:column; gap:2px;">
                                    <button class="btn btn-secondary" style="padding:2px 6px; font-size:0.7rem;"
                                            onclick="moveSchemaGroup(${gIdx}, -1)" ${gIdx === 0 ? "disabled" : ""}>‚ñ≤</button>
                                    <button class="btn btn-secondary" style="padding:2px 6px; font-size:0.7rem;"
                                            onclick="moveSchemaGroup(${gIdx}, 1)" ${gIdx === data.project_meta_schema.length - 1 ? "disabled" : ""}>‚ñº</button>
                                </div>
                                <input type="text" value="${group.group_label || ""}"
                                       placeholder="Áæ§ÁµÑÂêçÁ®± (ÂøÖÂ°´)"
                                       style="${!group.group_label ? "border-color:#e74c3c;" : ""}"
                                       onchange="updateSchemaGroup(${gIdx}, 'group_label', this.value); this.style.borderColor = this.value.trim() ? '' : '#e74c3c';">
                            </div>
                            <div class="group-actions">
                                <button class="btn btn-secondary" style="padding:4px 8px; font-size:0.8rem;"
                                        onclick="addFieldToGroup(${gIdx})">+ Ê¨Ñ‰Ωç</button>
                                <button class="btn btn-danger" style="padding:4px 8px;"
                                        onclick="removeSchemaGroup(${gIdx})">√ó</button>
                            </div>
                        </div>
                        <div class="schema-group-body">
                            <table class="schema-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px"></th>
                                        <th style="width: 130px">Key</th>
                                        <th style="width: 130px">Label</th>
                                        <th style="width: 120px">Type</th>
                                        <th style="width: 50px">ÂøÖÂ°´</th>
                                        <th style="width: 60px">Á∏ΩË¶Ω</th>
                                        <th style="width: 50px">ÂÇôË®ª</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(group.fields || [])
                                        .map(
                                            (field, fIdx) => `
                                        <tr data-group-idx="${gIdx}" data-field-idx="${fIdx}">
                                            <td><span class="drag-handle" data-group-idx="${gIdx}" data-field-idx="${fIdx}">‚ò∞</span></td>
                                            <td><input type="text" value="${field.key || ""}"
                                                       style="${!field.key ? "border-color:#e74c3c;" : ""}"
                                                       placeholder="ÂøÖÂ°´"
                                                       onchange="updateSchemaField(${gIdx}, ${fIdx}, 'key', this.value); this.style.borderColor = this.value.trim() ? '' : '#e74c3c';"></td>
                                            <td><input type="text" value="${field.label || ""}"
                                                       style="${!field.label ? "border-color:#e74c3c;" : ""}"
                                                       placeholder="ÂøÖÂ°´"
                                                       onchange="updateSchemaField(${gIdx}, ${fIdx}, 'label', this.value); this.style.borderColor = this.value.trim() ? '' : '#e74c3c';"></td>
                                            <td style="display:flex;align-items:center;gap:4px;">
                                                <select onchange="updateSchemaField(${gIdx}, ${fIdx}, 'type', this.value)">
                                                    <option value="text" ${field.type === "text" ? "selected" : ""}>text</option>
                                                    <option value="textarea" ${field.type === "textarea" ? "selected" : ""}>textarea</option>
                                                    <option value="date" ${field.type === "date" ? "selected" : ""}>date</option>
                                                    <option value="path_selector" ${field.type === "path_selector" ? "selected" : ""}>path_selector</option>
                                                    <option value="checkbox_group" ${field.type === "checkbox_group" ? "selected" : ""}>checkbox_group</option>
                                                    <option value="hidden" ${field.type === "hidden" ? "selected" : ""}>hidden</option>
                                                </select>
                                                ${field.type === "checkbox_group" ? `<button class="edit-options-btn" onclick="openOptionsSidebar(${gIdx}, ${fIdx})">Á∑®ËºØ</button>` : ""}
                                            </td>
                                            <td><input type="checkbox" ${field.required ? "checked" : ""}
                                                       onchange="updateSchemaField(${gIdx}, ${fIdx}, 'required', this.checked)"></td>
                                            <td><input type="checkbox" ${field.show_in_overview ? "checked" : ""}
                                                       onchange="updateSchemaField(${gIdx}, ${fIdx}, 'show_in_overview', this.checked)"></td>
                                            <td><input type="checkbox" ${field.remark ? "checked" : ""}
                                                       onchange="updateSchemaField(${gIdx}, ${fIdx}, 'remark', this.checked)"></td>
                                            <td><button class="btn btn-danger" style="padding:4px 8px;"
                                                        onclick="removeSchemaField(${gIdx}, ${fIdx})">√ó</button></td>
                                        </tr>
                                    `,
                                        )
                                        .join("")}
                                </tbody>
                            </table>
                            ${(group.fields || []).length === 0 ? `<div class="empty-group-drop" data-group-idx="${gIdx}" style="color:#666; padding:20px; text-align:center; border:2px dashed rgba(255,255,255,0.2); border-radius:4px;">ÊãñÊõ≥Ê¨Ñ‰ΩçËá≥Ê≠§</div>` : ""}
                        </div>
                    </div>
                `,
                    )
                    .join("");

                // Add custom drag listeners for drag handles
                container.querySelectorAll(".drag-handle").forEach((handle) => {
                    handle.addEventListener("mousedown", handleCustomDragStart);
                });

                // Add drop listeners for empty groups
                container
                    .querySelectorAll(".empty-group-drop")
                    .forEach((dropZone) => {
                        dropZone.addEventListener("dragover", (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = "move";
                            dropZone.style.borderColor = "#667eea";
                            dropZone.style.background =
                                "rgba(102, 126, 234, 0.1)";
                        });
                        dropZone.addEventListener("dragleave", (e) => {
                            dropZone.style.borderColor =
                                "rgba(255,255,255,0.2)";
                            dropZone.style.background = "transparent";
                        });
                        dropZone.addEventListener("drop", (e) => {
                            e.preventDefault();
                            const targetGroupIdx = parseInt(
                                dropZone.dataset.groupIdx,
                            );
                            dropZone.style.borderColor =
                                "rgba(255,255,255,0.2)";
                            dropZone.style.background = "transparent";

                            if (
                                dragSrcGroupIdx !== null &&
                                dragSrcFieldIdx !== null
                            ) {
                                const item = data.project_meta_schema[
                                    dragSrcGroupIdx
                                ].fields.splice(dragSrcFieldIdx, 1)[0];
                                if (
                                    !data.project_meta_schema[targetGroupIdx]
                                        .fields
                                ) {
                                    data.project_meta_schema[
                                        targetGroupIdx
                                    ].fields = [];
                                }
                                data.project_meta_schema[
                                    targetGroupIdx
                                ].fields.push(item);
                                renderSchemaTable();
                                saveToLocalStorage();
                            }
                            dragSrcGroupIdx = null;
                            dragSrcFieldIdx = null;
                        });
                    });
            }

            // Custom drag-and-drop implementation for fields
            let draggedRow = null;
            let placeholder = null;
            let dragGhost = null;
            let ghostOffsetX = 0;
            let ghostOffsetY = 0;

            // Auto-scroll variables
            let autoScrollSpeed = 0;
            let autoScrollFrame = null;

            function autoScroll() {
                if (autoScrollSpeed !== 0) {
                    const activeTab = document.querySelector(
                        ".tab-content.active",
                    );
                    if (activeTab) {
                        const container =
                            activeTab.querySelector(".form-container");
                        if (container) {
                            container.scrollTop += autoScrollSpeed;
                        }
                    }
                    autoScrollFrame = requestAnimationFrame(autoScroll);
                } else {
                    cancelAnimationFrame(autoScrollFrame);
                    autoScrollFrame = null;
                }
            }

            function handleCustomDragStart(e) {
                if (e.button !== 0) return; // Only left click
                e.preventDefault(); // Prevent default browser drag behavior

                const handle = e.currentTarget;
                draggedRow = handle.closest("tr");
                if (!draggedRow) return;

                dragSrcGroupIdx = parseInt(draggedRow.dataset.groupIdx);
                dragSrcFieldIdx = parseInt(draggedRow.dataset.fieldIdx);

                draggedRow.classList.add("dragging");

                // Create ghost element
                dragGhost = draggedRow.cloneNode(true);
                dragGhost.classList.add("drag-ghost");
                dragGhost.style.width = draggedRow.offsetWidth + "px";

                // Copy computed styles for cells to maintain appearance
                const originalCells = draggedRow.querySelectorAll("td");
                const ghostCells = dragGhost.querySelectorAll("td");
                originalCells.forEach((cell, index) => {
                    if (ghostCells[index]) {
                        ghostCells[index].style.width = cell.offsetWidth + "px";
                    }
                });

                // Calculate offset to position ghost relative to cursor
                const rect = draggedRow.getBoundingClientRect();
                ghostOffsetX = e.clientX - rect.left;
                ghostOffsetY = e.clientY - rect.top;

                dragGhost.style.left = e.clientX - ghostOffsetX + "px";
                dragGhost.style.top = e.clientY - ghostOffsetY + "px";

                document.body.appendChild(dragGhost);

                // Create a placeholder
                placeholder = document.createElement("tr");
                placeholder.classList.add("drag-placeholder");
                placeholder.style.height = draggedRow.offsetHeight + "px";
                placeholder.innerHTML = `<td colspan="8"></td>`; // Span all columns

                draggedRow.parentNode.insertBefore(
                    placeholder,
                    draggedRow.nextSibling,
                );

                document.addEventListener("mousemove", handleCustomDragMove);
                document.addEventListener("mouseup", handleCustomDragEnd);
            }

            function handleCustomDragMove(e) {
                if (!draggedRow) return;

                // Move ghost element
                if (dragGhost) {
                    dragGhost.style.left = e.clientX - ghostOffsetX + "px";
                    dragGhost.style.top = e.clientY - ghostOffsetY + "px";
                }

                // Hide original row, show placeholder
                draggedRow.style.display = "none";
                placeholder.style.display = "table-row";

                // Find the schema group under cursor
                const elementsUnderCursor = document.elementsFromPoint(
                    e.clientX,
                    e.clientY,
                );
                let targetGroup = null;

                for (const el of elementsUnderCursor) {
                    // Check if element is valid
                    if (!el) continue;

                    // Ignore ghost and dragged items
                    if (
                        el === dragGhost ||
                        el.contains(dragGhost) ||
                        el === draggedRow
                    )
                        continue;

                    if (el.classList && el.classList.contains("schema-group")) {
                        targetGroup = el;
                        break;
                    }
                    // Also check closest parent
                    const group = el.closest
                        ? el.closest(".schema-group")
                        : null;
                    if (group) {
                        targetGroup = group;
                        break;
                    }
                }

                // Clear styling for empty drops
                document.querySelectorAll(".empty-group-drop").forEach((el) => {
                    el.style.borderColor = "rgba(255,255,255,0.2)";
                    el.style.background = "transparent";
                });

                if (!targetGroup) return;

                const tbody = targetGroup.querySelector(".schema-table tbody");
                const emptyDropMsg =
                    targetGroup.querySelector(".empty-group-drop");

                if (!tbody) return;

                // Get all valid rows in the target group
                const rows = Array.from(tbody.querySelectorAll("tr")).filter(
                    (r) =>
                        r !== draggedRow &&
                        r !== placeholder &&
                        r !== dragGhost &&
                        r.style.display !== "none",
                );

                if (rows.length === 0) {
                    // Empty group logic: Highlight drop zone and append placeholder
                    if (emptyDropMsg) {
                        emptyDropMsg.style.borderColor = "#667eea";
                        emptyDropMsg.style.background =
                            "rgba(102, 126, 234, 0.1)";
                    }
                    tbody.appendChild(placeholder);
                } else {
                    // Find closest row logic
                    let closestRow = null;
                    let minDistance = Infinity;
                    let insertAfter = false;

                    rows.forEach((row) => {
                        const box = row.getBoundingClientRect();
                        const centerY = box.top + box.height / 2;
                        const dist = Math.abs(e.clientY - centerY);

                        if (dist < minDistance) {
                            minDistance = dist;
                            closestRow = row;
                            insertAfter = e.clientY > centerY;
                        }
                    });

                    if (closestRow) {
                        if (insertAfter) {
                            closestRow.parentNode.insertBefore(
                                placeholder,
                                closestRow.nextSibling,
                            );
                        } else {
                            closestRow.parentNode.insertBefore(
                                placeholder,
                                closestRow,
                            );
                        }
                    } else {
                        // Should rare happen if rows > 0, but safest fallback
                        tbody.appendChild(placeholder);
                    }
                }

                // Auto-scroll detection
                const activeTab = document.querySelector(".tab-content.active");
                if (activeTab) {
                    const container =
                        activeTab.querySelector(".form-container");
                    if (container) {
                        const rect = container.getBoundingClientRect();
                        const threshold = 50; // pixels from edge to trigger scroll
                        const maxSpeed = 15;

                        if (e.clientY < rect.top + threshold) {
                            // Scroll Up
                            const intensity =
                                (rect.top + threshold - e.clientY) / threshold;
                            autoScrollSpeed = -Math.max(
                                2,
                                intensity * maxSpeed,
                            );
                            if (!autoScrollFrame) autoScroll();
                        } else if (e.clientY > rect.bottom - threshold) {
                            // Scroll Down
                            const intensity =
                                (e.clientY - (rect.bottom - threshold)) /
                                threshold;
                            autoScrollSpeed = Math.max(2, intensity * maxSpeed);
                            if (!autoScrollFrame) autoScroll();
                        } else {
                            autoScrollSpeed = 0;
                        }
                    }
                }
            }

            function handleCustomDragEnd(e) {
                document.removeEventListener("mousemove", handleCustomDragMove);
                document.removeEventListener("mouseup", handleCustomDragEnd);
                document.body.style.cursor = "";

                // Stop auto-scroll
                autoScrollSpeed = 0;
                if (autoScrollFrame) {
                    cancelAnimationFrame(autoScrollFrame);
                    autoScrollFrame = null;
                }

                if (dragGhost && dragGhost.parentNode) {
                    dragGhost.parentNode.removeChild(dragGhost);
                    dragGhost = null;
                }

                if (!draggedRow) return;

                draggedRow.classList.remove("dragging");
                draggedRow.style.display = "table-row"; // Show the original row again

                // Clear styling (drag-over removed)
                document.querySelectorAll(".empty-group-drop").forEach((el) => {
                    el.style.borderColor = "rgba(255,255,255,0.2)";
                    el.style.background = "transparent";
                });

                if (placeholder && placeholder.parentNode) {
                    const newParentTbody = placeholder.parentNode;
                    const newGroup = newParentTbody.closest(".schema-group");
                    const newGroupIdx = parseInt(newGroup.dataset.groupIdx);
                    const newFieldIdx = Array.from(newParentTbody.children)
                        .filter((el) => el !== draggedRow)
                        .indexOf(placeholder);

                    // Perform the data update
                    if (
                        dragSrcGroupIdx !== null &&
                        dragSrcFieldIdx !== null &&
                        newGroupIdx !== null &&
                        newFieldIdx !== -1
                    ) {
                        const item = data.project_meta_schema[
                            dragSrcGroupIdx
                        ].fields.splice(dragSrcFieldIdx, 1)[0];

                        if (!data.project_meta_schema[newGroupIdx].fields) {
                            data.project_meta_schema[newGroupIdx].fields = [];
                        }
                        data.project_meta_schema[newGroupIdx].fields.splice(
                            newFieldIdx,
                            0,
                            item,
                        );
                        saveToLocalStorage();
                    }
                    placeholder.parentNode.removeChild(placeholder);
                }

                draggedRow = null;
                placeholder = null;
                dragSrcGroupIdx = null;
                dragSrcFieldIdx = null;
                renderSchemaTable(); // Re-render to update indices and UI
            }

            // The following native drag-and-drop functions are no longer used for fields,
            // but are kept for reference or if other elements still use them.
            function handleFieldDragStart(e) {
                // This function is now replaced by handleCustomDragStart for drag handles
                // If you intend to use native drag-and-drop for the entire row,
                // you would attach this to the 'dragstart' event of the <tr>.
                // For now, it's effectively unused for field dragging.
                dragSrcGroupIdx = parseInt(e.currentTarget.dataset.groupIdx);
                dragSrcFieldIdx = parseInt(e.currentTarget.dataset.fieldIdx);
                e.currentTarget.classList.add("dragging");
                e.dataTransfer.effectAllowed = "move";
            }

            function handleFieldDragEnd(e) {
                e.currentTarget.classList.remove("dragging");
                document.querySelectorAll(".schema-table tr").forEach((row) => {
                    row.classList.remove("drag-over");
                });
            }

            function handleFieldDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            }

            function handleFieldDragEnter(e) {
                e.currentTarget.classList.add("drag-over");
            }

            function handleFieldDragLeave(e) {
                e.currentTarget.classList.remove("drag-over");
            }

            function handleFieldDrop(e) {
                e.preventDefault();

                const targetGroupIdx = parseInt(
                    e.currentTarget.dataset.groupIdx,
                );
                const targetFieldIdx = parseInt(
                    e.currentTarget.dataset.fieldIdx,
                );
                e.currentTarget.classList.remove("drag-over");

                if (dragSrcGroupIdx !== null && dragSrcFieldIdx !== null) {
                    // ÂÖÅË®±Ë∑®Áæ§ÁµÑÁßªÂãïÊ¨Ñ‰Ωç
                    if (
                        dragSrcGroupIdx !== targetGroupIdx ||
                        dragSrcFieldIdx !== targetFieldIdx
                    ) {
                        const item = data.project_meta_schema[
                            dragSrcGroupIdx
                        ].fields.splice(dragSrcFieldIdx, 1)[0];
                        data.project_meta_schema[targetGroupIdx].fields.splice(
                            targetFieldIdx,
                            0,
                            item,
                        );
                        renderSchemaTable();
                        saveToLocalStorage();
                    }
                }
                dragSrcGroupIdx = null;
                dragSrcFieldIdx = null;
            }

            // ===== Group Move =====
            function moveSchemaGroup(gIdx, direction) {
                const newIdx = gIdx + direction;
                if (newIdx < 0 || newIdx >= data.project_meta_schema.length)
                    return;

                const item = data.project_meta_schema.splice(gIdx, 1)[0];
                data.project_meta_schema.splice(newIdx, 0, item);
                renderSchemaTable();
                saveToLocalStorage();
            }

            function addSchemaGroup() {
                data.project_meta_schema.unshift({
                    group_label: "",
                    fields: [],
                });
                renderSchemaTable();
                saveToLocalStorage();
            }

            function updateSchemaGroup(gIdx, key, value) {
                data.project_meta_schema[gIdx][key] = value;
                saveToLocalStorage();
            }

            function removeSchemaGroup(gIdx) {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Áæ§ÁµÑÂèäÂÖ∂ÊâÄÊúâÊ¨Ñ‰ΩçÂóéÔºü")) return;
                data.project_meta_schema.splice(gIdx, 1);
                renderSchemaTable();
                saveToLocalStorage();
            }

            function addFieldToGroup(gIdx) {
                if (!data.project_meta_schema[gIdx].fields) {
                    data.project_meta_schema[gIdx].fields = [];
                }
                data.project_meta_schema[gIdx].fields.push({
                    key: "",
                    label: "",
                    type: "text",
                    required: false,
                    show_in_overview: false,
                    remark: false,
                });
                renderSchemaTable();
                saveToLocalStorage();
            }

            function updateSchemaField(gIdx, fIdx, key, value) {
                data.project_meta_schema[gIdx].fields[fIdx][key] = value;

                // Re-render table when type changes (to show/hide edit button)
                if (key === "type") {
                    renderSchemaTable();
                }

                saveToLocalStorage();
            }

            function removeSchemaField(gIdx, fIdx) {
                data.project_meta_schema[gIdx].fields.splice(fIdx, 1);
                renderSchemaTable();
                saveToLocalStorage();
            }

            // ===== Options Sidebar =====
            let currentOptGIdx = null;
            let currentOptFIdx = null;
            let optDragState = null;

            function openOptionsSidebar(gIdx, fIdx) {
                // Toggle: if clicking same field's edit button, close sidebar
                if (currentOptGIdx === gIdx && currentOptFIdx === fIdx) {
                    closeOptionsSidebar();
                    return;
                }

                currentOptGIdx = gIdx;
                currentOptFIdx = fIdx;

                const field = data.project_meta_schema[gIdx].fields[fIdx];
                const fieldLabel = field.label || field.key || "(Êú™ÂëΩÂêçÊ¨Ñ‰Ωç)";

                // Initialize options array if needed
                if (!field.options) {
                    field.options = [];
                    saveToLocalStorage();
                }

                // Update sidebar title
                document.getElementById("options-sidebar-title").textContent =
                    `Á∑®ËºØÈÅ∏È†Ö - ${fieldLabel}`;

                // Render options list
                renderOptionsList();

                // Open sidebar with push effect
                document
                    .getElementById("options-sidebar")
                    .classList.add("open");
                document
                    .getElementById("tab-schema")
                    .classList.add("sidebar-open");
            }

            // ESC key to close sidebar
            document.addEventListener("keydown", function (e) {
                if (
                    e.key === "Escape" &&
                    document
                        .getElementById("options-sidebar")
                        .classList.contains("open")
                ) {
                    closeOptionsSidebar();
                }
            });

            function closeOptionsSidebar() {
                document
                    .getElementById("options-sidebar")
                    .classList.remove("open");
                document
                    .getElementById("tab-schema")
                    .classList.remove("sidebar-open");
                currentOptGIdx = null;
                currentOptFIdx = null;

                // Re-render to update button if options changed
                renderSchemaTable();
            }

            function renderOptionsList() {
                if (currentOptGIdx === null || currentOptFIdx === null) return;

                const field =
                    data.project_meta_schema[currentOptGIdx].fields[
                        currentOptFIdx
                    ];
                const options = field.options || [];
                const container = document.getElementById("options-list");

                if (options.length === 0) {
                    container.innerHTML =
                        '<div style="text-align:center;color:#71717a;padding:30px;">Â∞öÁÑ°ÈÅ∏È†ÖÔºåË´ãÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢û</div>';
                    return;
                }

                container.innerHTML = options
                    .map(
                        (opt, idx) => `
                    <div class="option-item" data-opt-idx="${idx}">
                        <span class="drag-handle" 
                              onmousedown="startOptDrag(event, ${idx})">‚ò∞</span>
                        <div class="inputs">
                            <input type="text" 
                                   placeholder="Value (ÂÑ≤Â≠òÂÄº)" 
                                   value="${opt.value || ""}"
                                   class="${!opt.value ? "error" : ""}"
                                   onchange="updateSidebarOption(${idx}, 'value', this.value)"
                                   oninput="this.classList.toggle('error', !this.value.trim())">
                            <input type="text" 
                                   placeholder="Label (È°ØÁ§∫ÂêçÁ®±)" 
                                   value="${opt.label || ""}"
                                   class="${!opt.label ? "error" : ""}"
                                   onchange="updateSidebarOption(${idx}, 'label', this.value)"
                                   oninput="this.classList.toggle('error', !this.value.trim())">
                        </div>
                        <button class="delete-btn" onclick="removeSidebarOption(${idx})">√ó</button>
                    </div>
                `,
                    )
                    .join("");
            }

            function addOptionToSidebar() {
                if (currentOptGIdx === null || currentOptFIdx === null) return;

                const field =
                    data.project_meta_schema[currentOptGIdx].fields[
                        currentOptFIdx
                    ];
                if (!field.options) field.options = [];

                field.options.push({ value: "", label: "" });
                saveToLocalStorage();
                renderOptionsList();
            }

            function updateSidebarOption(optIdx, key, value) {
                if (currentOptGIdx === null || currentOptFIdx === null) return;

                data.project_meta_schema[currentOptGIdx].fields[
                    currentOptFIdx
                ].options[optIdx][key] = value;
                saveToLocalStorage();
            }

            function removeSidebarOption(optIdx) {
                if (currentOptGIdx === null || currentOptFIdx === null) return;

                data.project_meta_schema[currentOptGIdx].fields[
                    currentOptFIdx
                ].options.splice(optIdx, 1);
                saveToLocalStorage();
                renderOptionsList();
            }

            // Option drag reorder with ghost and auto-scroll
            let optGhost = null;
            let optGhostOffsetY = 0;
            let optAutoScrollSpeed = 0;
            let optAutoScrollFrame = null;
            let optPlaceholder = null;

            function optAutoScroll() {
                if (optAutoScrollSpeed !== 0) {
                    const sidebarContent = document.querySelector(
                        ".options-sidebar-content",
                    );
                    if (sidebarContent) {
                        sidebarContent.scrollTop += optAutoScrollSpeed;
                    }
                    optAutoScrollFrame = requestAnimationFrame(optAutoScroll);
                } else {
                    cancelAnimationFrame(optAutoScrollFrame);
                    optAutoScrollFrame = null;
                }
            }

            function startOptDrag(e, optIdx) {
                e.preventDefault();
                const item = e.target.closest(".option-item");
                const itemRect = item.getBoundingClientRect();

                optDragState = {
                    idx: optIdx,
                    item: item,
                    startY: e.clientY,
                    itemRect: itemRect,
                };

                // Create ghost element
                optGhost = item.cloneNode(true);
                optGhost.style.position = "fixed";
                optGhost.style.left = itemRect.left + "px";
                optGhost.style.top = itemRect.top + "px";
                optGhost.style.width = itemRect.width + "px";
                optGhost.style.opacity = "0.8";
                optGhost.style.pointerEvents = "none";
                optGhost.style.zIndex = "2000";
                optGhost.style.boxShadow = "0 8px 25px rgba(0,0,0,0.4)";
                optGhost.style.transform = "scale(1.02)";
                document.body.appendChild(optGhost);

                optGhostOffsetY = e.clientY - itemRect.top;

                // Create placeholder
                optPlaceholder = document.createElement("div");
                optPlaceholder.className = "option-item opt-placeholder";
                optPlaceholder.style.height = itemRect.height + "px";
                optPlaceholder.style.background = "rgba(59, 130, 246, 0.1)";
                optPlaceholder.style.border = "2px dashed #3b82f6";
                optPlaceholder.style.borderRadius = "8px";

                item.classList.add("dragging");
                item.parentNode.insertBefore(optPlaceholder, item.nextSibling);

                document.addEventListener("mousemove", handleOptDragMove);
                document.addEventListener("mouseup", handleOptDragEnd);
            }

            function handleOptDragMove(e) {
                if (!optDragState || !optGhost) return;

                // Update ghost position
                optGhost.style.top = e.clientY - optGhostOffsetY + "px";

                // Auto-scroll detection for sidebar content
                const sidebarContent = document.querySelector(
                    ".options-sidebar-content",
                );
                if (sidebarContent) {
                    const contentRect = sidebarContent.getBoundingClientRect();
                    const scrollThreshold = 50;
                    const scrollSpeed = 8;

                    if (
                        e.clientY < contentRect.top + scrollThreshold &&
                        e.clientY > contentRect.top
                    ) {
                        optAutoScrollSpeed = -scrollSpeed;
                        if (!optAutoScrollFrame) optAutoScroll();
                    } else if (
                        e.clientY > contentRect.bottom - scrollThreshold &&
                        e.clientY < contentRect.bottom
                    ) {
                        optAutoScrollSpeed = scrollSpeed;
                        if (!optAutoScrollFrame) optAutoScroll();
                    } else {
                        optAutoScrollSpeed = 0;
                    }
                }

                // Find drop position - only look within options-list
                const optionsList = document.getElementById("options-list");
                if (!optionsList) return;

                const items = Array.from(
                    optionsList.querySelectorAll(
                        ".option-item:not(.dragging):not(.opt-placeholder)",
                    ),
                );

                let insertBefore = null;
                for (const item of items) {
                    const rect = item.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        insertBefore = item;
                        break;
                    }
                }

                // Move placeholder within options-list only
                if (
                    optPlaceholder &&
                    optPlaceholder.parentNode === optionsList
                ) {
                    if (insertBefore) {
                        optionsList.insertBefore(optPlaceholder, insertBefore);
                    } else {
                        // Append to end of options-list
                        optionsList.appendChild(optPlaceholder);
                    }
                }
            }

            function handleOptDragEnd(e) {
                if (!optDragState) return;

                // Stop auto-scroll
                optAutoScrollSpeed = 0;
                if (optAutoScrollFrame) {
                    cancelAnimationFrame(optAutoScrollFrame);
                    optAutoScrollFrame = null;
                }

                // Remove ghost
                if (optGhost && optGhost.parentNode) {
                    optGhost.parentNode.removeChild(optGhost);
                    optGhost = null;
                }

                // Calculate new index based on placeholder position within options-list
                const optionsList = document.getElementById("options-list");
                const allItems = optionsList
                    ? Array.from(
                          optionsList.querySelectorAll(
                              ".option-item, .opt-placeholder",
                          ),
                      )
                    : [];
                let newIdx = 0;
                allItems.forEach((el, idx) => {
                    if (el === optPlaceholder) {
                        newIdx = idx;
                    }
                });

                // Remove placeholder
                if (optPlaceholder && optPlaceholder.parentNode) {
                    optPlaceholder.parentNode.removeChild(optPlaceholder);
                    optPlaceholder = null;
                }

                optDragState.item.classList.remove("dragging");

                document.removeEventListener("mousemove", handleOptDragMove);
                document.removeEventListener("mouseup", handleOptDragEnd);

                // Adjust newIdx to account for the dragged item's original position
                const originalIdx = optDragState.idx;
                if (newIdx > originalIdx) {
                    newIdx--;
                }

                // Reorder if changed
                if (
                    newIdx !== originalIdx &&
                    currentOptGIdx !== null &&
                    currentOptFIdx !== null
                ) {
                    const options =
                        data.project_meta_schema[currentOptGIdx].fields[
                            currentOptFIdx
                        ].options;
                    const [moved] = options.splice(originalIdx, 1);
                    options.splice(newIdx, 0, moved);
                    saveToLocalStorage();
                    renderOptionsList();
                }

                optDragState = null;
            }

            // ===== Sidebar =====
            let isNewItem = false; // Ê®ôË®òÊòØÂê¶ÁÇ∫Êñ∞Â¢û‰∏≠ÁöÑÈ†ÖÁõÆ
            let expandedSections = new Set(); // Ë®òÈåÑÂ±ïÈñãÁöÑÁ´†ÁØÄ Index

            function toggleSection(sIdx) {
                const header = document.querySelector(
                    `.section-header[data-section="${sIdx}"]`,
                );
                const items = document.getElementById(`section-items-${sIdx}`);

                header.classList.toggle("expanded");
                items.classList.toggle("expanded");

                if (header.classList.contains("expanded")) {
                    expandedSections.add(sIdx);
                } else {
                    expandedSections.delete(sIdx);
                }
            }

            function renderSidebar() {
                // Ëá™ÂãïÂÑ≤Â≠òÁõÆÂâçÁöÑÁãÄÊÖã (ÂåÖÂê´ÂâõÂåØÂÖ•Êàñ‰øÆÊîπÁöÑË≥áÊñô)
                saveToLocalStorage();

                const container = document.getElementById("sidebar-tree");
                if (!data.test_standards || data.test_standards.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state" style="padding:40px;"><div>Â∞öÁÑ°Á´†ÁØÄ</div></div>';
                    return;
                }

                container.innerHTML = data.test_standards
                    .map(
                        (sec, sIdx) => `
                <div class="section-item">
                    <div class="section-header ${
                        expandedSections.has(sIdx) ? "expanded" : ""
                    }" data-section="${sIdx}">
                        <div class="section-info" onclick="toggleSection(${sIdx}); editSection(${sIdx});">
                            <span class="arrow">‚ñ∂</span>
                            <span>${sec.section_id} ${sec.section_name}</span>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteSection(${sIdx})">Âà™Èô§</button>
                    </div>
                    <div class="section-items ${
                        expandedSections.has(sIdx) ? "expanded" : ""
                    }" id="section-items-${sIdx}">
                        ${(sec.items || [])
                            .map(
                                (item, iIdx) => `
                            <div class="item-entry" onclick="editItem(${sIdx}, ${iIdx})" data-section="${sIdx}" data-item="${iIdx}">
                                ${item.id} ${item.name}
                            </div>
                        `,
                            )
                            .join("")}
                        <div class="item-entry" style="color:#667eea;" onclick="addItem(${sIdx})">+ Êñ∞Â¢ûÊ∏¨È†Ö</div>
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            function addSection() {
                const id = prompt("Ë´ãËº∏ÂÖ•Á´†ÁØÄ IDÔºà‰æãÔºö6Ôºâ");
                if (!id) return;
                const name = prompt("Ë´ãËº∏ÂÖ•Á´†ÁØÄÂêçÁ®±Ôºà‰æãÔºö6.Á≥ªÁµ±Ê™¢Ê∏¨Ôºâ");
                if (!name) return;

                data.test_standards.push({
                    section_id: id,
                    section_name: name,
                    items: [],
                });
                renderSidebar();
                editSection(data.test_standards.length - 1);
            }

            // Ê™¢Êü•ÊòØÂê¶ÊúâÊú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥ÊàñÈúÄË¶ÅËá™ÂãïÂà™Èô§
            function checkUnsaved(nextActionCallback) {
                // Â¶ÇÊûúÊòØÊñ∞È†ÖÁõÆ‰∏îË¢´Âà§ÂÆöÁÇ∫„ÄåÁ©∫„Äç(ID/NameÁÇ∫Á©∫)ÔºåÁõ¥Êé•Âà™Èô§ (ÈÄôÈÉ®ÂàÜÈÇèËºØ‰øùÁïô)
                if (currentEditType === "item" && isNewItem) {
                    const id = document.getElementById("edit-item-id")?.value;
                    const name =
                        document.getElementById("edit-item-name")?.value;
                    if (!id && !name) {
                        data.test_standards[currentEditIndex].items.splice(
                            currentEditItemIndex,
                            1,
                        );
                        renderSidebar();
                        console.log("Empty new item auto-deleted");
                        nextActionCallback();
                        return;
                    }
                }

                // Ê™¢Êü•ÊòØÂê¶ÊúâÊú™ÂÑ≤Â≠òÁöÑÊñáÂ≠óËÆäÊõ¥
                if (currentEditType) {
                    const original = getOriginalData();
                    const current = getCurrentFormData();

                    if (JSON.stringify(original) !== JSON.stringify(current)) {
                        if (!confirm("ÊÇ®ÊúâÊú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥ÔºåÁ¢∫ÂÆöË¶ÅÈõ¢ÈñãÂóéÔºü")) {
                            return; // ÂèñÊ∂àÂàáÊèõ (Stay)
                        } else {
                            // User chose to leave (Discard changes)
                            // Â¶ÇÊûúÊòØÊñ∞È†ÖÁõÆÔºåÊó¢ÁÑ∂ÊîæÊ£ÑÂÑ≤Â≠òÔºåÂ∞±ÊáâË©≤Âà™Èô§ÂÆÉ
                            if (currentEditType === "item" && isNewItem) {
                                data.test_standards[
                                    currentEditIndex
                                ].items.splice(currentEditItemIndex, 1);
                                renderSidebar();
                                console.log(
                                    "Unsaved new item deleted on discard",
                                );
                            }
                        }
                    }
                }

                nextActionCallback();
            }

            // ÂèñÂæóÁõÆÂâçË°®ÂñÆË≥áÊñô (Áî®ÊñºÊØîÂ∞ç)
            function getCurrentFormData() {
                if (currentEditType === "section") {
                    return {
                        id:
                            document.getElementById("edit-section-id")?.value ||
                            "",
                        name:
                            document.getElementById("edit-section-name")
                                ?.value || "",
                    };
                } else if (currentEditType === "item") {
                    return {
                        id:
                            document.getElementById("edit-item-id")?.value ||
                            "",
                        name:
                            document.getElementById("edit-item-name")?.value ||
                            "",
                        uid:
                            document.getElementById("edit-item-uid")?.value ||
                            "",
                        criteria_version:
                            document.getElementById("edit-item-version")
                                ?.value || "",
                        purpose:
                            document.getElementById("edit-purpose")?.value ||
                            "",
                        method:
                            document.getElementById("edit-method")?.value || "",
                        criteria:
                            document.getElementById("edit-criteria")?.value ||
                            "",
                    };
                }
                return null;
            }

            // ÂèñÂæóÂéüÂßãË≥áÊñô (Áî®ÊñºÊØîÂ∞ç)
            function getOriginalData() {
                if (currentEditType === "section") {
                    const sec = data.test_standards[currentEditIndex];
                    return { id: sec.section_id, name: sec.section_name };
                } else if (currentEditType === "item") {
                    const item =
                        data.test_standards[currentEditIndex].items[
                            currentEditItemIndex
                        ];
                    if (!item) return null; // item might be deleted
                    return {
                        id: item.id || "",
                        name: item.name || "",
                        uid: item.uid || "",
                        criteria_version: item.criteria_version || "",
                        purpose: item.narrative?.purpose || "",
                        method: item.narrative?.method || "",
                        criteria: item.narrative?.criteria || "",
                    };
                }
                return null;
            }

            function editSection(sIdx) {
                checkUnsaved(() => {
                    _doEditSection(sIdx);
                });
            }

            function _doEditSection(sIdx) {
                currentEditType = "section";
                currentEditIndex = sIdx;
                currentEditItemIndex = null;
                isNewItem = false;

                // È´ò‰∫Æ
                document
                    .querySelectorAll(".section-header")
                    .forEach((h) => h.classList.remove("active"));
                document
                    .querySelectorAll(".item-entry")
                    .forEach((e) => e.classList.remove("active"));
                document
                    .querySelector(`.section-header[data-section="${sIdx}"]`)
                    ?.classList.add("active");

                const sec = data.test_standards[sIdx];
                document.getElementById("editor-panel").innerHTML = `
                <h2>Á∑®ËºØÁ´†ÁØÄ</h2>
                <div class="editor-section">
                    <div class="editor-row">
                        <div class="form-group small">
                            <label>Á´†ÁØÄ ID</label>
                            <input type="text" id="edit-section-id" value="${sec.section_id}">
                        </div>
                        <div class="form-group">
                            <label>Á´†ÁØÄÂêçÁ®±</label>
                            <input type="text" id="edit-section-name" value="${sec.section_name}">
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveSection()">üíæ ÂÑ≤Â≠òÁ´†ÁØÄ</button>
                    <button class="btn btn-danger" onclick="deleteSection(${sIdx})">üóëÔ∏è Âà™Èô§Á´†ÁØÄ</button>
                </div>
            `;
            }

            function saveSection() {
                if (currentEditType !== "section") return;
                data.test_standards[currentEditIndex].section_id =
                    document.getElementById("edit-section-id").value;
                data.test_standards[currentEditIndex].section_name =
                    document.getElementById("edit-section-name").value;
                renderSidebar();
                alert("Â∑≤ÂÑ≤Â≠òÔºÅ"); // Â¢ûÂä†ÊèêÁ§∫
            }

            function deleteSection(sIdx) {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Á´†ÁØÄÂèäÂÖ∂ÊâÄÊúâÊ∏¨È†ÖÂóéÔºü")) return;
                data.test_standards.splice(sIdx, 1);
                renderSidebar();
                clearEditor();
            }

            // ===== Item Editor =====
            function addItem(sIdx) {
                // ÂÖàÊ™¢Êü•Áï∂ÂâçÊòØÂê¶ÊúâÊú™ÂÑ≤Â≠ò
                checkUnsaved(() => {
                    const defaultVersion =
                        document.getElementById("default_criteria_version")
                            ?.value || "MODA_v1.0";
                    data.test_standards[sIdx].items.push({
                        id: "",
                        name: "",
                        uid: "",
                        criteria_version: defaultVersion,
                        targets: [],
                        logic: "AND",
                        narrative: { purpose: "", method: "", criteria: "" },
                        handler: { class_name: "BaseTestTool" },
                        checklist: [],
                    });
                    renderSidebar();

                    // Ë®≠ÂÆöÊñ∞Â¢ûÊ®ôË®ò
                    const newIdx = data.test_standards[sIdx].items.length - 1;
                    _doEditItem(sIdx, newIdx, true);
                });
            }

            function editItem(sIdx, iIdx) {
                checkUnsaved(() => {
                    _doEditItem(sIdx, iIdx, false);
                });
            }

            function _doEditItem(sIdx, iIdx, isNew) {
                currentEditType = "item";
                currentEditIndex = sIdx;
                currentEditItemIndex = iIdx;
                isNewItem = isNew;

                // È´ò‰∫Æ
                document
                    .querySelectorAll(".section-header")
                    .forEach((h) => h.classList.remove("active"));
                document
                    .querySelectorAll(".item-entry")
                    .forEach((e) => e.classList.remove("active"));
                document
                    .querySelector(
                        `.item-entry[data-section="${sIdx}"][data-item="${iIdx}"]`,
                    )
                    ?.classList.add("active");

                // Â±ïÈñã section
                document
                    .querySelector(`.section-header[data-section="${sIdx}"]`)
                    ?.classList.add("expanded");
                document
                    .getElementById(`section-items-${sIdx}`)
                    ?.classList.add("expanded");

                const item = data.test_standards[sIdx].items[iIdx];
                const hasUAV = item.targets?.includes("UAV");
                const hasGCS = item.targets?.includes("GCS");

                document.getElementById("editor-panel").innerHTML = `
                <h2>Á∑®ËºØÊ∏¨È†Ö</h2>
                <div class="editor-section">
                    <h3>Âü∫Êú¨Ë≥áË®ä</h3>
                    <div class="editor-row">
                        <div class="form-group small">
                            <label>Ê∏¨È†Ö ID</label>
                            <input type="text" id="edit-item-id" value="${
                                item.id || ""
                            }">
                        </div>
                        <div class="form-group">
                            <label>Ê∏¨È†ÖÂêçÁ®±</label>
                            <input type="text" id="edit-item-name" value="${
                                item.name || ""
                            }">
                        </div>
                    </div>
                    <div class="editor-row">
                        <div class="form-group">
                            <label>UID</label>
                            <input type="text" id="edit-item-uid" value="${
                                item.uid || ""
                            }">
                        </div>
                        <div class="form-group">
                            <label>Âà§ÂÆöÁâàÊú¨</label>
                            <input type="text" id="edit-item-version" value="${
                                item.criteria_version || ""
                            }">
                        </div>
                    </div>
                    <div class="editor-row">
                        <div class="form-group">
                            <label>Ê∏¨Ë©¶Â∞çË±°</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="edit-target-uav" ${
                                    hasUAV ? "checked" : ""
                                }> UAV</label>
                                <label><input type="checkbox" id="edit-target-gcs" ${
                                    hasGCS ? "checked" : ""
                                }> GCS</label>
                            </div>
                        </div>
                        <div class="form-group small">
                            <label>ÈÇèËºØ</label>
                            <select id="edit-item-logic">
                                <option value="AND" ${
                                    item.logic === "AND" ? "selected" : ""
                                }>AND</option>
                                <option value="OR" ${
                                    item.logic === "OR" ? "selected" : ""
                                }>OR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Handler</label>
                            <select id="edit-item-handler">
                                <option value="BaseTestTool" ${
                                    item.handler?.class_name === "BaseTestTool"
                                        ? "selected"
                                        : ""
                                }>BaseTestTool</option>
                                <option value="NmapTestTool" ${
                                    item.handler?.class_name === "NmapTestTool"
                                        ? "selected"
                                        : ""
                                }>NmapTestTool</option>
                                <option value="CommandTestTool" ${
                                    item.handler?.class_name ===
                                    "CommandTestTool"
                                        ? "selected"
                                        : ""
                                }>CommandTestTool</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>Ê∏¨Ë©¶ÊïòËø∞</h3>
                    <div class="form-group">
                        <label>Ê∏¨Ë©¶ÁõÆÁöÑ</label>
                        <textarea id="edit-purpose">${
                            item.narrative?.purpose || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label>Ê∏¨Ë©¶ÊñπÊ≥ï</label>
                        <textarea id="edit-method">${
                            item.narrative?.method || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label>Âà§ÂÆöÊ®ôÊ∫ñ (ÊúÉËá™ÂãïÊãÜËß£ÁÇ∫ Checklist)</label>
                        <textarea id="edit-criteria" oninput="previewChecklist()">${
                            item.narrative?.criteria || ""
                        }</textarea>
                        <div class="checklist-preview" id="checklist-preview">
                            <h4>Checklist È†êË¶Ω</h4>
                            <div id="checklist-items"></div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveItem()">üíæ ÂÑ≤Â≠òÊ∏¨È†Ö</button>
                    <button class="btn btn-danger" onclick="deleteItem()">üóëÔ∏è Âà™Èô§Ê∏¨È†Ö</button>
                </div>
            `;

                previewChecklist();
            }

            function previewChecklist() {
                const criteria =
                    document.getElementById("edit-criteria")?.value || "";
                const lines = criteria.split("\n").filter((l) => l.trim());
                const checklistItems = [];

                lines.forEach((line, idx) => {
                    const match = line.match(/^\s*\(?\d+\)?[\.\s]*(.*)/);
                    if (match) {
                        checklistItems.push(match[1].trim());
                    } else if (idx > 0) {
                        // ÈùûÁ¨¨‰∏ÄË°å‰∏îÈùûÁ∑®ËôüÊ†ºÂºèÔºå‰πüÂä†ÂÖ•
                        checklistItems.push(line.trim());
                    }
                });

                const container = document.getElementById("checklist-items");
                if (checklistItems.length === 0) {
                    container.innerHTML =
                        '<div style="color:#666;">ÁÑ°Ê≥ïËß£Êûê Checklist È†ÖÁõÆ</div>';
                } else {
                    container.innerHTML = checklistItems
                        .map(
                            (item, idx) => `
                    <div class="checklist-item"><span class="id">c${
                        idx + 1
                    }</span>${item}</div>
                `,
                        )
                        .join("");
                }
            }

            function saveItem() {
                if (currentEditType !== "item") return;

                // È©óË≠âÊ∏¨Ë©¶Â∞çË±°
                const isUAV =
                    document.getElementById("edit-target-uav").checked;
                const isGCS =
                    document.getElementById("edit-target-gcs").checked;
                if (!isUAV && !isGCS) {
                    alert("Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ∏¨Ë©¶Â∞çË±° (UAV Êàñ GCS)ÔºÅ");
                    return;
                }

                const item =
                    data.test_standards[currentEditIndex].items[
                        currentEditItemIndex
                    ];

                item.id = document.getElementById("edit-item-id").value;
                item.name = document.getElementById("edit-item-name").value;
                item.uid = document.getElementById("edit-item-uid").value;
                item.criteria_version =
                    document.getElementById("edit-item-version").value;
                item.logic = document.getElementById("edit-item-logic").value;
                item.handler = {
                    class_name:
                        document.getElementById("edit-item-handler").value,
                };

                // Targets
                item.targets = [];
                if (isUAV) item.targets.push("UAV");
                if (isGCS) item.targets.push("GCS");

                // Narrative
                item.narrative = {
                    purpose: document.getElementById("edit-purpose").value,
                    method: document.getElementById("edit-method").value,
                    criteria: document.getElementById("edit-criteria").value,
                };

                // Checklist
                const criteria =
                    document.getElementById("edit-criteria").value || "";
                const lines = criteria.split("\n").filter((l) => l.trim());
                const checklistItems = [];
                lines.forEach((line, idx) => {
                    const match = line.match(/^\s*\(?\d+\)?[\.\s]*(.*)/);
                    if (match) {
                        checklistItems.push(match[1].trim());
                    } else if (idx > 0) {
                        checklistItems.push(line.trim());
                    }
                });
                item.checklist = checklistItems.map((content, idx) => ({
                    id: `c${idx + 1}`,
                    content: content,
                }));

                renderSidebar();
                alert("Â∑≤ÂÑ≤Â≠òÔºÅ");
            }

            function deleteItem() {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê∏¨È†ÖÂóéÔºü")) return;
                data.test_standards[currentEditIndex].items.splice(
                    currentEditItemIndex,
                    1,
                );
                renderSidebar();
                clearEditor();
            }

            function clearEditor() {
                currentEditType = null;
                currentEditIndex = null;
                currentEditItemIndex = null;
                document.getElementById("editor-panel").innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìù</div>
                    <div>Ë´ãÂæûÂ∑¶ÂÅ¥ÈÅ∏ÊìáÁ´†ÁØÄÊàñÊ∏¨È†ÖÈÄ≤Ë°åÁ∑®ËºØ</div>
                    <div style="margin-top:10px; font-size:0.9rem;">ÊàñÈªûÊìä„Äå+ Á´†ÁØÄ„ÄçÊñ∞Â¢û</div>
                </div>
            `;
            }

            // ===== ÂàùÂßãÂåñ =====
            // renderSchemaTable(); // Áî± loadFromLocalStorage ÂëºÂè´ÔºåÈÅøÂÖçË¶ÜÂØ´ Storage
            // renderSidebar();     // Áî± loadFromLocalStorage ÂëºÂè´ÔºåÈÅøÂÖçË¶ÜÂØ´ Storage
        </script>
    </body>
</html>
