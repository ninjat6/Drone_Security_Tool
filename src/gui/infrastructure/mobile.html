<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"
        />
        <title>ğŸ“± æ‰‹æ©ŸåŠ©æ‰‹</title>
        <style>
            html {
                height: 100%;
                overflow: hidden;
                overscroll-behavior: none;
            }
            * {
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, sans-serif;
                margin: 0;
                padding: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
                color: #333;
            }
            .container {
                position: relative;
                width: 100%;
                height: 100%;
                overflow: hidden;
                padding: 0; /* padding ç§»åˆ° page å…§éƒ¨ */
            }
            /* é€šç”¨é é¢å®¹å™¨ */
            .page-view {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 20px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                display: none; /* é è¨­éš±è— */
                background: transparent; /* è®“ body èƒŒæ™¯é€å‡ºä¾†ï¼Œæˆ–è€…è¨­ç‚ºç™½è‰²çœ‹éœ€æ±‚ */
            }
            .page-view.active {
                display: block;
            }

            /* --- Restored Styles --- */
            .card {
                background: white;
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: white;
                text-align: center;
                margin: 20px 0;
                font-size: 1.5rem;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            h2 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                color: #444;
            }
            .project-name {
                font-size: 1.1rem;
                color: #E3E3E3;
                text-align: center;
                margin-bottom: 20px;
            }
            .menu-btn {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 18px 20px;
                background: #f8f9fa;
                border: none;
                border-radius: 12px;
                width: 100%;
                font-size: 16px;
                cursor: pointer;
                margin-bottom: 10px;
                transition: all 0.2s;
            }
            .menu-btn:hover,
            .menu-btn:active {
                background: #e9ecef;
                transform: scale(0.98);
            }
            .menu-btn .icon {
                font-size: 28px;
            }
            .menu-btn .text {
                flex: 1;
                text-align: left;
            }
            .menu-btn .arrow {
                color: #aaa;
                font-size: 20px;
            }
            .item-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .item-list li {
                padding: 15px;
                border-bottom: 1px solid #eee;
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
            }
            .item-list li:last-child {
                border-bottom: none;
            }
            .item-list li:hover {
                background: #f8f9fa;
            }
            .item-id {
                font-weight: bold;
                color: #667eea;
                min-width: 50px;
            }
            .item-name {
                flex: 1;
            }
            .item-status {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 4px;
            }
            .status-done {
                background: #d4edda;
                color: #155724;
            }
            .status-pending {
                background: #fff3cd;
                color: #856404;
            }
            .back-btn {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                color: white;
                text-decoration: none;
                font-size: 14px;
                margin-bottom: 10px;
            }
            .hidden {
                display: none !important;
            }
            #loading {
                text-align: center;
                padding: 40px;
                color: white;
            }
            /* ä¸Šå‚³é æ¨£å¼ */
            .upload-header {
                background: #667eea;
                color: white;
                padding: 15px;
                margin: -20px -20px 20px -20px;
                border-radius: 16px 16px 0 0;
            }
            .upload-header h3 {
                margin: 0;
                font-size: 1rem;
            }
            .upload-header .subtitle {
                font-size: 0.8rem;
                opacity: 0.8;
                margin-top: 5px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                font-weight: bold;
                margin-bottom: 5px;
                color: #555;
            }
            .form-group select,
            .form-group input[type="text"] {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .btn {
                display: block;
                width: 100%;
                padding: 14px;
                font-size: 16px;
                font-weight: bold;
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                margin: 8px 0;
            }
            .btn-primary {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }
            .btn-success {
                background: #28a745;
            }
            .btn-secondary {
                background: #6c757d;
            }
            .btn-danger {
                background: #dc3545;
            }
            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-row {
                display: flex;
                gap: 10px;
            }
            .btn-row .btn {
                margin: 0;
            }
            /* åœ–ç‰‡ç·¨è¼¯ */
            .img-container {
                width: 100%;
                height: 50vh;
                background: #333;
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 10px;
            }
            .img-container img {
                max-width: 100%;
                display: block;
            }
            .canvas-wrapper {
                width: 100%;
                border: 2px solid #ddd;
                border-radius: 8px;
                background: #fff;
                margin-bottom: 10px;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .controls-panel {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 10px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            .control-item {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 14px;
            }
            input[type="color"] {
                border: none;
                width: 40px;
                height: 35px;
                cursor: pointer;
                background: none;
            }
            input[type="range"] {
                width: 80px;
            }
            #status {
                text-align: center;
                font-weight: bold;
                padding: 10px;
                color: #666;
            }
            /* ------------------- */

            /* å‹•ç•«é¡åˆ¥ */
            .page-view {
                transform: translateX(0);
                will-change: transform;
                z-index: 1; /* é è¨­å±¤ç´š */
            }
            .page-view.interactive {
                transition: none !important;
            }
            .page-view.animating {
                transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            }

            .anim-enter-right {
                z-index: 10;
                animation: slideInRight 0.2s forwards;
            }
            .anim-exit-left {
                z-index: 1;
                animation: slideOutLeft 0.2s forwards;
            }
            .anim-enter-left {
                z-index: 9; 
                animation: slideInLeft 0.2s forwards;
            }
            .anim-exit-right {
                z-index: 10;
                animation: slideOutRight 0.2s forwards;
            }
            
            /* Interactive helper classes */
            .page-on-left {
                transform: translateX(-30%);
                display: block;
                z-index: 1;
            }
            .page-on-right {
                transform: translateX(30%);
                display: block;
                z-index: 1;
            }

            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 1; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutLeft {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(-30%); opacity: 0; }
            }
            @keyframes slideInLeft {
                from { transform: translateX(-30%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 1; }
            }

            /* Pull to Refresh */
            #refresh-loader {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 0;
                color: rgba(255, 255, 255, 0.9);
                font-weight: bold;
                pointer-events: none;
            }
            #refresh-loader .icon {
                font-size: 24px;
                margin-right: 8px;
                transition: transform 0.2s;
                display: inline-block;
            }
            #refresh-loader .spinner {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>


        </style>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
        />
    </head>
    <body>
        <div class="container">
    <body>
        <div class="container">
            <div id="refresh-loader">
                <span class="icon" id="refresh-icon"></span>
                <span class="text" id="refresh-text"></span>
            </div>

            <!-- é¦–é  -->
            <div id="page-home" class="page-view active">
                <h1>ğŸ“± æ‰‹æ©ŸåŠ©æ‰‹</h1>
                <p class="project-name" id="project-name">å°ˆæ¡ˆè¼‰å…¥ä¸­...</p>
                <div class="card">
                    <button class="menu-btn" onclick="showPage('overview')">
                        <span class="icon">ğŸ“·</span>
                        <span class="text"
                            >ç¸½è¦½ç…§ç‰‡<br /><small style="color: #888"
                                >UAV / GCS å…­é¢ç…§</small
                            ></span
                        >
                        <span class="arrow">â€º</span>
                    </button>
                    <button class="menu-btn" onclick="showPage('items')">
                        <span class="icon">ğŸ“‹</span>
                        <span class="text"
                            >æ¸¬é …ä½è­‰<br /><small style="color: #888"
                                >æª¢æ¸¬é …ç›®é™„ä»¶</small
                            ></span
                        >
                        <span class="arrow">â€º</span>
                    </button>
                </div>
            </div>

            <!-- ç¸½è¦½ç…§ç‰‡é  -->
            <div id="page-overview" class="page-view">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('home', 'back'); return false;"
                    >â† è¿”å›</a
                >
                <h1>ğŸ“· ç¸½è¦½ç…§ç‰‡</h1>
                <div class="card">
                    <div class="form-group">
                        <label>é¸æ“‡ç›®æ¨™</label>
                        <select id="overview-target">
                            <option value="UAV">UAV (ç„¡äººæ©Ÿ)</option>
                            <option value="GCS">GCS (åœ°é¢ç«™)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¸æ“‡è¦–è§’</label>
                        <select id="overview-angle">
                            <option value="front">æ­£é¢ (Front)</option>
                            <option value="back">èƒŒé¢ (Back)</option>
                            <option value="side1">å´é¢1 (Side 1)</option>
                            <option value="side2">å´é¢2 (Side 2)</option>
                            <option value="top">ä¸Šæ–¹ (Top)</option>
                            <option value="bottom">ä¸‹æ–¹ (Bottom)</option>
                        </select>
                    </div>
                    <input
                        type="file"
                        id="overview-file"
                        accept="image/*"
                        style="display: none"
                        onchange="onOverviewFileSelected(event)"
                    />
                    <button
                        class="btn btn-primary"
                        onclick="document.getElementById('overview-file').click()"
                    >
                        ğŸ“· æ‹ç…§æˆ–é¸å–ç…§ç‰‡
                    </button>
                </div>
            </div>

            <!-- æ¸¬é …åˆ—è¡¨é  -->
            <div id="page-items" class="page-view">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('home', 'back'); return false;"
                    >â† è¿”å›</a
                >
                <h1>ğŸ“‹ æ¸¬é …ä½è­‰</h1>
                <div class="card">
                    <ul class="item-list" id="item-list">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <!-- ä¸Šå‚³é ï¼ˆæ¸¬é …ä½è­‰ï¼‰ -->
            <div id="page-upload" class="page-view">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('items', 'back'); return false;"
                    >â† è¿”å›æ¸¬é …åˆ—è¡¨</a
                >
                <div class="card">
                    <div class="upload-header">
                        <h3 id="upload-item-name">æ¸¬é …åç¨±</h3>
                        <div class="subtitle" id="upload-item-id">ID</div>
                    </div>

                    <!-- Step 0: é¸æ“‡ -->
                    <div id="upload-step0">
                        <div class="form-group" id="target-select-group">
                            <label>é¸æ“‡ç›®æ¨™</label>
                            <select id="upload-target">
                                <option value="UAV">UAV</option>
                                <option value="GCS">GCS</option>
                                <option value="Shared">å…±ç”¨</option>
                            </select>
                        </div>
                        <input
                            type="file"
                            id="upload-file"
                            accept="image/*"
                            style="display: none"
                            onchange="onUploadFileSelected(event)"
                        />
                        <button
                            class="btn btn-primary"
                            onclick="document.getElementById('upload-file').click()"
                        >
                            ğŸ“· æ‹ç…§æˆ–é¸å–ç…§ç‰‡
                        </button>
                    </div>

                    <!-- Step 1: è£å‰ª -->
                    <div id="upload-step1" class="hidden">
                        <div class="img-container">
                            <img id="image-to-crop" src="" />
                        </div>
                        <div class="btn-row">
                            <button
                                class="btn btn-secondary"
                                onclick="resetUpload()"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                class="btn btn-primary"
                                onclick="finishCrop()"
                            >
                                ä¸‹ä¸€æ­¥ â¡ï¸
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: æ¨™è¨˜ -->
                    <div id="upload-step2" class="hidden">
                        <div class="form-group">
                            <label>åœ–ç‰‡æ¨™é¡Œ</label>
                            <input
                                type="text"
                                id="upload-title"
                                placeholder="è¼¸å…¥æ¨™é¡Œï¼ˆé¸å¡«ï¼‰"
                            />
                        </div>
                        <div class="controls-panel">
                            <div class="control-item">
                                é¡è‰²:
                                <input
                                    type="color"
                                    id="line-color"
                                    value="#ff0000"
                                />
                            </div>
                            <div class="control-item">
                                ç²—ç´°:
                                <input
                                    type="range"
                                    id="line-width"
                                    min="1"
                                    max="15"
                                    value="5"
                                /><span id="width-val">5</span>
                            </div>
                        </div>
                        <div class="canvas-wrapper">
                            <canvas id="fabric-canvas"></canvas>
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-danger" onclick="addRect()">
                                + æ¡†ç·š
                            </button>
                            <button
                                class="btn btn-secondary"
                                onclick="removeActiveObject()"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                        <div id="status"></div>
                        <div class="btn-row" style="margin-top: 15px">
                            <button
                                class="btn btn-secondary"
                                onclick="backToCrop()"
                            >
                                â¬…ï¸ é‡è£
                            </button>
                            <button
                                class="btn btn-success"
                                id="btn-upload"
                                onclick="doUpload()"
                            >
                                â˜ï¸ ä¸Šå‚³
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loading" class="hidden">è¼‰å…¥ä¸­...</div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
        <script>
            // å…¨åŸŸè®Šæ•¸
            let projectData = null;
            let currentItem = null;
            let cropper = null;
            let fabricCanvas = null;
            let originalImageWidth = 0;
            let uploadMode = "item"; // 'item' or 'overview'
            let originalImageData = null; // ä¿å­˜åŸå§‹åœ–ç‰‡ DataURL

            // åˆå§‹åŒ–
            async function init() {
                try {
                    const res = await fetch("/api/project?t=" + Date.now());
                    projectData = await res.json();
                    document.getElementById("project-name").innerText =
                        projectData.name || "æœªå‘½åå°ˆæ¡ˆ";
                    renderItemList();
                } catch (e) {
                    document.getElementById("project-name").innerText =
                        "é€£ç·šå¤±æ•—";
                    console.error(e);
                }
            }

            // é é¢åˆ‡æ›èˆ‡å‹•ç•«
            function showPage(page, direction = "forward") {
                const currentPages =
                    document.querySelectorAll(".page-view.active");
                const targetPage = document.getElementById("page-" + page);

                if (!targetPage) return;

                // å¦‚æœå·²ç¶“åœ¨é€™å€‹é é¢ï¼Œå‰‡ä¸å‹•ä½œ
                if (targetPage.classList.contains("active")) return;

                // ç§»é™¤æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„å‹•ç•«é¡åˆ¥ï¼Œé¿å…è¡çª
                document.querySelectorAll(".page-view").forEach((el) => {
                    el.classList.remove(
                        "anim-enter-right",
                        "anim-exit-left",
                        "anim-enter-left",
                        "anim-exit-right"
                    );
                });

                // è¨­å®šç›®æ¨™é é¢ç‚ºé¡¯ç¤º (å°šæœªæ·»åŠ  active é¿å…ç«‹å³é¡¯ç¤ºï¼Œç”±å‹•ç•«æ§åˆ¶)
                targetPage.style.display = "block";

                if (currentPages.length > 0) {
                    const currentPage = currentPages[0];

                    if (direction === "forward") {
                        // å‰é€²ï¼šèˆŠé é¢å·¦å‡ºï¼Œæ–°é é¢å³é€²
                        currentPage.classList.add("anim-exit-left");
                        targetPage.classList.add("anim-enter-right");
                    } else {
                        // è¿”å›ï¼šèˆŠé é¢å³å‡ºï¼Œæ–°é é¢å·¦é€²
                        currentPage.classList.add("anim-exit-right");
                        targetPage.classList.add("anim-enter-left");
                    }

                    // å‹•ç•«çµæŸæ¸…ç†
                    const onAnimEnd = () => {
                        currentPage.classList.remove(
                            "active",
                            "anim-exit-left",
                            "anim-exit-right"
                        );
                        currentPage.style.display = ""; // æ¸…é™¤ inline style

                        targetPage.classList.remove(
                            "anim-enter-right",
                            "anim-enter-left"
                        );
                        targetPage.classList.add("active");
                        targetPage.style.display = ""; // æ¸…é™¤ inline style

                        // ç§»é™¤ç›£è½å™¨
                        currentPage.removeEventListener(
                            "animationend",
                            onAnimEnd
                        );
                    };

                    // ç¶å®šåˆ°èˆŠé é¢ï¼Œå› ç‚ºè¦–éœ€è¦ç­‰å¾…èˆŠé é¢æ¶ˆå¤±
                    // é€™è£¡ç°¡åŒ–è™•ç†ï¼šåªç¶å®šä¸€å€‹ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                    currentPage.addEventListener("animationend", onAnimEnd, {
                        once: true,
                    });

                    // ç‚ºäº†ä¿éšªï¼Œè¨­å®šè¶…æ™‚å¼·åˆ¶æ¸…ç† (é¿å…å‹•ç•«æœªè§¸ç™¼å¡ä½)
                    setTimeout(onAnimEnd, 220);
                } else {
                    // åˆå§‹è¼‰å…¥ï¼ˆç„¡å‹•ç•«ï¼‰
                    targetPage.classList.add("active");
                }
            }

            // æ¸²æŸ“æ¸¬é …åˆ—è¡¨
            function renderItemList() {
                const list = document.getElementById("item-list");
                if (
                    !projectData ||
                    !projectData.items ||
                    projectData.items.length === 0
                ) {
                    list.innerHTML = "<li>æ²’æœ‰æ¸¬é …</li>";
                    return;
                }
                list.innerHTML = projectData.items
                    .map(
                        (item) => `
                <li onclick="selectItem('${item.uid}')">
                    <span class="item-id">${item.id}</span>
                    <span class="item-name">${item.name}</span>
                    <span class="arrow">â€º</span>
                </li>
            `
                    )
                    .join("");
            }

            // é¸æ“‡æ¸¬é …
            function selectItem(uid) {
                currentItem = projectData.items.find((i) => i.uid === uid);
                if (!currentItem) return;

                document.getElementById("upload-item-name").innerText =
                    currentItem.name;
                document.getElementById("upload-item-id").innerText =
                    currentItem.id;

                // è¨­å®šç›®æ¨™é¸æ“‡
                const targetSelect = document.getElementById("upload-target");
                const targetGroup = document.getElementById(
                    "target-select-group"
                );
                if (currentItem.targets && currentItem.targets.length > 1) {
                    targetGroup.classList.remove("hidden");
                    targetSelect.innerHTML =
                        currentItem.targets
                            .map((t) => `<option value="${t}">${t}</option>`)
                            .join("") + '<option value="Shared">å…±ç”¨</option>';
                } else {
                    targetGroup.classList.add("hidden");
                }

                uploadMode = "item";
                resetUpload();
                showPage("upload"); // é è¨­å‰é€²å‹•ç•«
            }

            // ç¸½è¦½ç…§ç‰‡é¸æ“‡
            function onOverviewFileSelected(e) {
                uploadMode = "overview";
                currentItem = {
                    id: document.getElementById("overview-target").value,
                    name:
                        document.getElementById("overview-target").value +
                        " ç…§ç‰‡",
                    uid: "overview",
                    targets: [document.getElementById("overview-target").value],
                };

                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        originalImageData = evt.target.result; // ä¿å­˜åŸåœ–
                        document.getElementById("image-to-crop").src =
                            evt.target.result;
                        document.getElementById("upload-item-name").innerText =
                            currentItem.name;
                        document.getElementById("upload-item-id").innerText =
                            document.getElementById("overview-angle").value;
                        document
                            .getElementById("target-select-group")
                            .classList.add("hidden");
                        showPage("upload"); // é è¨­å‰é€²å‹•ç•«
                        startCropMode();
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = "";
            }

            // æ¸¬é …ä¸Šå‚³é¸æ“‡
            function onUploadFileSelected(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        originalImageData = evt.target.result; // ä¿å­˜åŸåœ–
                        document.getElementById("image-to-crop").src =
                            evt.target.result;
                        startCropMode();
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = "";
            }

            // è£å‰ªæ¨¡å¼
            function startCropMode() {
                document.getElementById("upload-step0").classList.add("hidden");
                document
                    .getElementById("upload-step1")
                    .classList.remove("hidden");
                document.getElementById("upload-step2").classList.add("hidden");

                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(
                        document.getElementById("image-to-crop"),
                        {
                            viewMode: 1,
                            dragMode: "move",
                            autoCropArea: 0.9,
                            restore: false,
                            guides: true,
                            center: true,
                            highlight: false,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                        }
                    );
                }, 100);
            }

            // å®Œæˆè£å‰ª
            function finishCrop() {
                if (!cropper) return;
                const croppedCanvas = cropper.getCroppedCanvas({
                    maxWidth: 4096,
                    maxHeight: 4096,
                    imageSmoothingQuality: "high",
                });
                if (!croppedCanvas) {
                    alert("è£åˆ‡å¤±æ•—");
                    return;
                }
                originalImageWidth = croppedCanvas.width;
                startDrawMode(
                    croppedCanvas.toDataURL("image/jpeg", 0.95),
                    croppedCanvas.width,
                    croppedCanvas.height
                );
            }

            // æ¨™è¨˜æ¨¡å¼
            let croppedImageData = null; // å„²å­˜è£åˆ‡å¾Œçš„åœ–ç‰‡

            function startDrawMode(imageURL, w, h) {
                croppedImageData = imageURL; // ä¿å­˜åœ–ç‰‡æ•¸æ“š

                document.getElementById("upload-step1").classList.add("hidden");
                document
                    .getElementById("upload-step2")
                    .classList.remove("hidden");

                // ç­‰å¾…ä¸€ä¸‹ç¢ºä¿ DOM æ›´æ–°
                setTimeout(() => {
                    const container =
                        document.querySelector("#page-upload .card");
                    const containerWidth = container.clientWidth - 44;
                    const scaleFactor = containerWidth / w;
                    const finalWidth = containerWidth;
                    const finalHeight = h * scaleFactor;

                    if (fabricCanvas) {
                        fabricCanvas.dispose();
                        fabricCanvas = null;
                    }

                    const canvasEl = document.getElementById("fabric-canvas");

                    // å…ˆå»ºç«‹ canvas
                    fabricCanvas = new fabric.Canvas("fabric-canvas", {
                        width: finalWidth,
                        height: finalHeight,
                        selection: false,
                    });

                    // ä½¿ç”¨ Image ç‰©ä»¶è¼‰å…¥
                    const imgObj = new Image();
                    imgObj.onload = function () {
                        const fabricImg = new fabric.Image(imgObj, {
                            originX: "left",
                            originY: "top",
                            scaleX: scaleFactor,
                            scaleY: scaleFactor,
                            selectable: false,
                        });
                        fabricCanvas.setBackgroundImage(fabricImg, () => {
                            fabricCanvas.renderAll();
                        });
                    };
                    imgObj.src = imageURL;

                    fabricCanvas.on("selection:created", syncControls);
                    fabricCanvas.on("selection:updated", syncControls);
                }, 50);
            }

            // æ¡†ç·šæ§åˆ¶
            const colorInput = document.getElementById("line-color");
            const widthInput = document.getElementById("line-width");
            const widthVal = document.getElementById("width-val");

            widthInput.addEventListener("input", function () {
                widthVal.innerText = this.value;
                updateActiveObject();
            });
            colorInput.addEventListener("input", updateActiveObject);

            function updateActiveObject() {
                if (!fabricCanvas) return;
                const obj = fabricCanvas.getActiveObject();
                if (obj) {
                    obj.set({
                        stroke: colorInput.value,
                        strokeWidth: parseInt(widthInput.value, 10),
                    });
                    fabricCanvas.requestRenderAll();
                }
            }

            function syncControls(e) {
                const obj = e.selected[0];
                if (obj) {
                    colorInput.value = obj.stroke || "#ff0000";
                    widthInput.value = obj.strokeWidth || 5;
                    widthVal.innerText = obj.strokeWidth || 5;
                }
            }

            function addRect() {
                if (!fabricCanvas) return;
                const rect = new fabric.Rect({
                    left: fabricCanvas.width / 4,
                    top: fabricCanvas.height / 4,
                    width: fabricCanvas.width / 3,
                    height: fabricCanvas.height / 3,
                    fill: "transparent",
                    stroke: colorInput.value,
                    strokeWidth: parseInt(widthInput.value, 10),
                    cornerColor: "blue",
                    cornerSize: 20,
                    transparentCorners: false,
                    strokeUniform: true,
                });
                fabricCanvas.add(rect);
                fabricCanvas.setActiveObject(rect);
            }

            function removeActiveObject() {
                const obj = fabricCanvas.getActiveObject();
                if (obj) fabricCanvas.remove(obj);
            }

            function backToCrop() {
                document.getElementById("upload-step2").classList.add("hidden");
                document
                    .getElementById("upload-step1")
                    .classList.remove("hidden");
            }

            function resetUpload() {
                document
                    .getElementById("upload-step0")
                    .classList.remove("hidden");
                document.getElementById("upload-step1").classList.add("hidden");
                document.getElementById("upload-step2").classList.add("hidden");
                document.getElementById("upload-title").value = "";
                document.getElementById("status").innerText = "";
                document.getElementById("btn-upload").disabled = false;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                originalImageData = null; // æ¸…é™¤åŸåœ–è³‡æ–™
            }

            // ä¸Šå‚³
            async function doUpload() {
                if (!fabricCanvas) return;
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();

                const multiplier = originalImageWidth / fabricCanvas.getWidth();
                const dataURL = fabricCanvas.toDataURL({
                    format: "jpeg",
                    quality: 1.0,
                    multiplier: multiplier,
                });

                document.getElementById("status").innerText = "ä¸Šå‚³ä¸­...";
                document.getElementById("btn-upload").disabled = true;

                const blob = dataURLtoBlob(dataURL);
                const formData = new FormData();
                formData.append("photo", blob, "upload.jpg");
                
                // é™„åŠ åŸå§‹åœ–ç‰‡
                if (originalImageData) {
                    const originalBlob = dataURLtoBlob(originalImageData);
                    formData.append("original", originalBlob, "original.jpg");
                }
                
                formData.append(
                    "title",
                    document.getElementById("upload-title").value || ""
                );

                if (uploadMode === "overview") {
                    formData.append("mode", "overview");
                    const targetVal =
                        document.getElementById("overview-target").value;
                    const angleVal =
                        document.getElementById("overview-angle").value;
                    // è‡ªå‹•ç”¢ç”Ÿæ¨™é¡Œï¼šä¾‹å¦‚ "UAV æ­£é¢"
                    const angleNames = {
                        front: "æ­£é¢",
                        back: "èƒŒé¢",
                        side1: "å´é¢1",
                        side2: "å´é¢2",
                        top: "ä¸Šæ–¹",
                        bottom: "ä¸‹æ–¹",
                    };
                    const autoTitle =
                        targetVal + " " + (angleNames[angleVal] || angleVal);
                    formData.set("title", autoTitle);
                    formData.append("target", targetVal);
                    formData.append("angle", angleVal);
                } else {
                    formData.append("mode", "item");
                    formData.append("item_uid", currentItem.uid);
                    formData.append("item_id", currentItem.id);
                    formData.append("item_name", currentItem.name);
                    formData.append(
                        "target",
                        document.getElementById("upload-target").value
                    );
                }

                try {
                    const res = await fetch("/api/upload", {
                        method: "POST",
                        body: formData,
                    });
                    const data = await res.json();
                    if (data.status === "success") {
                        document.getElementById("status").innerText =
                            "âœ… ä¸Šå‚³æˆåŠŸ";
                        document.getElementById("status").style.color = "green";
                        setTimeout(() => {
                            alert("ä¸Šå‚³æˆåŠŸï¼");
                            resetUpload();
                            if (uploadMode === "overview") {
                                showPage("overview");
                            }
                        }, 500);
                    } else {
                        alert("å¤±æ•—: " + data.message);
                        document.getElementById("status").innerText = "";
                        document.getElementById("btn-upload").disabled = false;
                    }
                } catch (e) {
                    alert("ç¶²è·¯éŒ¯èª¤");
                    document.getElementById("status").innerText = "";
                    document.getElementById("btn-upload").disabled = false;
                }
            }

            function dataURLtoBlob(dataurl) {
                const arr = dataurl.split(",");
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) u8arr[n] = bstr.charCodeAt(n);
                return new Blob([u8arr], { type: mime });
            }

            // --- æ»‘å‹•æ‰‹å‹¢è¿”å› & ä¸‹æ‹‰æ›´æ–°åŠŸèƒ½ ---
            let touchStartX = 0;
            let touchStartY = 0;
            let touchData = null; // { type: 'back' | 'refresh', ... }
            let isPullingRefresh = false;

            const GESTURE_ZONE_WIDTH = 50; // è¿”å›æ‰‹å‹¢å·¦å´å¯¬åº¦
            const SWIPE_THRESHOLD = 230; // è¿”å›ç¢ºèªé–¾å€¼
            const PULL_THRESHOLD = 120; // ä¸‹æ‹‰åˆ·æ–°ç¢ºèªé–¾å€¼

            // ä¸‹æ‹‰åˆ·æ–° UI å…ƒç´ 
            const refreshLoader = document.getElementById('refresh-loader');
            const refreshIcon = document.getElementById('refresh-icon');
            const refreshText = document.getElementById('refresh-text');

            function updateRefreshUI(progress) { // 0.0 ~ 1.0+
                if (progress >= 1.0) {
                    refreshText.innerText = 'é‡‹æ”¾æ›´æ–°';
                    refreshIcon.style.transform = 'rotate(180deg)';
                } else {
                    // refreshText.innerText = 'ä¸‹æ‹‰æ›´æ–°';
                    // refreshIcon.style.transform = 'rotate(0deg)';
                }
            }

            function setRefreshingState(refreshing) {
                if (refreshing) {
                    refreshText.innerText = 'è¼‰å…¥ä¸­...';
                    refreshIcon.innerText = 'âŒ›'; // æˆ–ä½¿ç”¨ class æ·»åŠ  spinner
                    refreshIcon.classList.add('spinner');
                    refreshIcon.style.transform = '';
                } else {
                    // refreshText.innerText = 'ä¸‹æ‹‰æ›´æ–°';
                    // refreshIcon.innerText = 'â¬‡ï¸';
                    // refreshIcon.classList.remove('spinner');
                }
            }

            // å–å¾—ã€Œè¿”å›ã€çš„ç›®æ¨™é é¢ ID (ä¸åŸ·è¡Œè·³è½‰åªæ˜¯æŸ¥è©¢)
            function getBackTarget() {
                const homeActive = document
                    .getElementById("page-home")
                    .classList.contains("active");
                if (homeActive) return null;

                const overviewActive = document
                    .getElementById("page-overview")
                    .classList.contains("active");
                if (overviewActive) return "home";

                const itemsActive = document
                    .getElementById("page-items")
                    .classList.contains("active");
                if (itemsActive) return "home";

                const uploadActive = document
                    .getElementById("page-upload")
                    .classList.contains("active");
                if (uploadActive) {
                    const step0Hidden = document
                        .getElementById("upload-step0")
                        .classList.contains("hidden");
                    if (!step0Hidden) return "items";
                    // è£å‰ª/æ¨™è¨˜æ­¥é©Ÿä¸­é€šå¸¸ç¦æ­¢æ»‘å‹•è¿”å›ï¼Œä»¥å…èª¤è§¸
                    return null;
                }
                return null;
            }

            document.addEventListener("touchstart", (e) => {
                const touch = e.changedTouches[0];
                touchStartX = touch.pageX;
                touchStartY = touch.pageY;

                // æª¢æŸ¥æ˜¯å¦åœ¨ç‰¹æ®Šäº’å‹•å€åŸŸï¼ˆå¦‚ Slider, CropperCanvasï¼‰
                if (
                    e.target.closest(".cropper-container") ||
                    e.target.closest(".canvas-container") ||
                    e.target.closest('input[type="range"]') ||
                    e.target.closest(".img-container")
                ) {
                    touchData = null;
                    return;
                }

                // åˆ¤æ–·ä¸‹æ‹‰åˆ·æ–°æ¢ä»¶ï¼šå¿…é ˆåœ¨é ‚éƒ¨
                // æ³¨æ„ï¼šé€™è£¡å‡è¨­åªæœ‰ body/container æœ¬èº«æ»¾å‹•ï¼Œæˆ–è€… page-view æ»¾å‹•
                // ç”±æ–¼ css è¨­å®š page-view ç‚º overflow-y: autoï¼Œæ‰€ä»¥è¦æª¢æŸ¥ activePage.scrollTop
                const activePage = document.querySelector(".page-view.active");
                const scrollTop = activePage ? activePage.scrollTop : 0;
                
                const backTargetId = getBackTarget();

                touchData = {
                    startX: touchStartX,
                    startY: touchStartY,
                    scrollTop: scrollTop,
                    activePage: activePage,
                    backTargetId: backTargetId,
                    width: window.innerWidth,
                    isMoving: false,
                    type: null // 'back' or 'refresh' or 'scroll'
                };
            });

            document.addEventListener("touchmove", (e) => {
                if (!touchData) return;

                const touch = e.changedTouches[0];
                const deltaX = touch.pageX - touchData.startX;
                const deltaY = touch.pageY - touchData.startY;
                const absX = Math.abs(deltaX);
                const absY = Math.abs(deltaY);

                // å°šæœªæ±ºå®šæ„åœ–
                if (!touchData.isMoving) {
                    if (absX < 5 && absY < 5) return; // ç§»å‹•å¤ªå°

                    // åˆ¤æ–·æ„åœ–
                    if (absY > absX && deltaY > 0 && touchData.scrollTop === 0) {
                        // å‘ä¸‹æ‹‰ & åœ¨é ‚éƒ¨ -> Refresh
                        touchData.type = 'refresh';
                        touchData.isMoving = true;
                        setRefreshingState(false);
                    } else if (absX > absY && deltaX > 0 && touchData.backTargetId) {
                        // å‘å³æ»‘ & æœ‰è¿”å›ç›®æ¨™ -> Back
                        touchData.type = 'back';
                        touchData.isMoving = true;
                        
                        // åˆå§‹åŒ– Back UI
                        const targetPage = document.getElementById("page-" + touchData.backTargetId);
                        touchData.targetPage = targetPage;
                        
                        touchData.activePage.classList.add('interactive');
                        targetPage.classList.add('interactive');
                        
                        targetPage.style.display = 'block';
                        targetPage.style.zIndex = '1';
                        touchData.activePage.style.zIndex = '10';
                    } else {
                        // å…¶ä»–æ–¹å‘ -> ä¸€èˆ¬æ»¾å‹•
                        touchData.type = 'scroll';
                        touchData.isMoving = true; // é–å®šç‚ºæ»¾å‹•ï¼Œä¸è™•ç†
                        return;
                    }
                }

                if (touchData.isMoving) {
                    if (touchData.type === 'refresh') {
                        // Pull to Refresh
                        e.preventDefault(); // é˜»æ­¢åŸç”Ÿæ»¾å‹•
                        
                        // å¢åŠ é˜»å°¼æ„Ÿ
                        let translateY = deltaY * 0.5;
                        if (translateY > PULL_THRESHOLD * 1.5) {
                            translateY = PULL_THRESHOLD * 1.5 + (translateY - PULL_THRESHOLD * 1.5) * 0.2;
                        }
                        
                        touchData.activePage.style.transform = `translateY(${translateY}px)`;
                        
                        const progress = Math.min(translateY / PULL_THRESHOLD, 1.5);
                        updateRefreshUI(progress);
                        
                    } else if (touchData.type === 'back') {
                        // Swipe Back
                        e.preventDefault();
                        
                        const progress = Math.min(Math.max(deltaX / touchData.width, 0), 1);
                        touchData.activePage.style.transform = `translateX(${deltaX}px)`;
                        
                        const targetStart = -0.3 * touchData.width;
                        const targetX = targetStart + (progress * Math.abs(targetStart));
                        touchData.targetPage.style.transform = `translateX(${targetX}px)`;
                    }
                }
            });

            document.addEventListener("touchend", (e) => {
                if (!touchData || !touchData.isMoving) {
                    touchData = null;
                    return;
                }

                if (touchData.type === 'refresh') {
                    // --- è™•ç†ä¸‹æ‹‰åˆ·æ–°çµæœ ---
                    const touch = e.changedTouches[0];
                    const deltaY = touch.pageY - touchData.startY;
                    const effectiveY = deltaY * 0.5; // ç´„ç•¥ä¼°è¨ˆ
                    
                    const shouldRefresh = effectiveY > PULL_THRESHOLD;

                    // åŠ å…¥ transition
                    touchData.activePage.classList.add('animating'); // æœ‰ transition-transform setting?
                    // æ ¹æ“š style section, .page-view.animating æ˜¯ 0.2s transform
                    
                    if (shouldRefresh) {
                        // é–å®šåœ¨è¼‰å…¥ä½ç½®
                        setRefreshingState(true);
                        touchData.activePage.style.transform = `translateY(60px)`; // Loader height
                        
                        setTimeout(() => {
                            location.reload(); // ç°¡å–®æš´åŠ›åˆ·æ–°
                            // å¦‚æœæ˜¯ SPA é‚è¼¯ï¼š
                            // await init();
                            // touchData.activePage.style.transform = '';
                            // touchData.activePage.classList.remove('animating');
                        }, 500); // é¡¯ç¤ºä¸€ä¸‹è¼‰å…¥å‹•ç•«
                    } else {
                        // å½ˆå›
                        touchData.activePage.style.transform = '';
                        setTimeout(() => {
                            touchData.activePage.classList.remove('animating');
                            updateRefreshUI(0);
                        }, 200);
                    }
                    touchData = null;

                } else if (touchData.type === 'back') {
                    // --- è™•ç†æ»‘å‹•è¿”å›çµæœ ---
                    const touch = e.changedTouches[0];
                    const deltaX = touch.pageX - touchData.startX;
                    const shouldFinish = (deltaX > SWIPE_THRESHOLD) || (deltaX > touchData.width * 0.3);

                    touchData.activePage.classList.remove('interactive');
                    touchData.targetPage.classList.remove('interactive');
                    
                    if (shouldFinish) {
                        touchData.activePage.classList.add('animating');
                        touchData.targetPage.classList.add('animating');

                        touchData.activePage.style.transform = 'translateX(100%)';
                        touchData.targetPage.style.transform = 'translateX(0)';

                        setTimeout(() => {
                            if (touchData && touchData.activePage) { // é˜²å‘†
                                touchData.activePage.classList.remove('active', 'animating');
                                touchData.activePage.style.display = '';
                                touchData.activePage.style.transform = '';
                                touchData.activePage.style.zIndex = '';

                                touchData.targetPage.classList.remove('animating');
                                touchData.targetPage.classList.add('active');
                                touchData.targetPage.style.display = '';
                                touchData.targetPage.style.transform = '';
                                touchData.targetPage.style.zIndex = '';
                            }
                            touchData = null;
                        }, 200);
                    } else {
                        const fastTransition = 'transform 0.15s ease-out, opacity 0.15s ease-out';
                        
                        touchData.activePage.style.transition = fastTransition;
                        touchData.activePage.style.transform = 'translateX(0)';
                        
                        touchData.targetPage.style.transition = fastTransition;
                        touchData.targetPage.style.transform = 'translateX(-30%)';
                        touchData.targetPage.style.opacity = '0';

                        setTimeout(() => {
                            if (touchData && touchData.activePage) {
                                touchData.activePage.style.transition = '';
                                touchData.activePage.style.zIndex = '';
                                
                                touchData.targetPage.style.transition = '';
                                touchData.targetPage.style.display = ''; 
                                touchData.targetPage.style.transform = '';
                                touchData.targetPage.style.zIndex = '';
                                touchData.targetPage.style.opacity = '';
                            }
                            touchData = null;
                        }, 150);
                    }
                } else {
                    touchData = null;
                }
            });


            // å•Ÿå‹•
            init();
        </script>
    </body>
</html>
