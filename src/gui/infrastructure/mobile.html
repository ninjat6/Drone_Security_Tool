<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"
        />
        <title>ğŸ“± æ‰‹æ©ŸåŠ©æ‰‹</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, sans-serif;
                margin: 0;
                padding: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }
            .container {
                max-width: 100%;
                padding: 20px;
            }
            .card {
                background: white;
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: white;
                text-align: center;
                margin: 20px 0;
                font-size: 1.5rem;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            h2 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                color: #444;
            }
            .project-name {
                font-size: 0.9rem;
                color: #666;
                text-align: center;
                margin-bottom: 20px;
            }
            .menu-btn {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 18px 20px;
                background: #f8f9fa;
                border: none;
                border-radius: 12px;
                width: 100%;
                font-size: 16px;
                cursor: pointer;
                margin-bottom: 10px;
                transition: all 0.2s;
            }
            .menu-btn:hover,
            .menu-btn:active {
                background: #e9ecef;
                transform: scale(0.98);
            }
            .menu-btn .icon {
                font-size: 28px;
            }
            .menu-btn .text {
                flex: 1;
                text-align: left;
            }
            .menu-btn .arrow {
                color: #aaa;
                font-size: 20px;
            }
            .item-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .item-list li {
                padding: 15px;
                border-bottom: 1px solid #eee;
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
            }
            .item-list li:last-child {
                border-bottom: none;
            }
            .item-list li:hover {
                background: #f8f9fa;
            }
            .item-id {
                font-weight: bold;
                color: #667eea;
                min-width: 50px;
            }
            .item-name {
                flex: 1;
            }
            .item-status {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 4px;
            }
            .status-done {
                background: #d4edda;
                color: #155724;
            }
            .status-pending {
                background: #fff3cd;
                color: #856404;
            }
            .back-btn {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                color: white;
                text-decoration: none;
                font-size: 14px;
                margin-bottom: 10px;
            }
            .hidden {
                display: none !important;
            }
            #loading {
                text-align: center;
                padding: 40px;
                color: white;
            }
            /* ä¸Šå‚³é æ¨£å¼ */
            .upload-header {
                background: #667eea;
                color: white;
                padding: 15px;
                margin: -20px -20px 20px -20px;
                border-radius: 16px 16px 0 0;
            }
            .upload-header h3 {
                margin: 0;
                font-size: 1rem;
            }
            .upload-header .subtitle {
                font-size: 0.8rem;
                opacity: 0.8;
                margin-top: 5px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                font-weight: bold;
                margin-bottom: 5px;
                color: #555;
            }
            .form-group select,
            .form-group input[type="text"] {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .btn {
                display: block;
                width: 100%;
                padding: 14px;
                font-size: 16px;
                font-weight: bold;
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                margin: 8px 0;
            }
            .btn-primary {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }
            .btn-success {
                background: #28a745;
            }
            .btn-secondary {
                background: #6c757d;
            }
            .btn-danger {
                background: #dc3545;
            }
            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-row {
                display: flex;
                gap: 10px;
            }
            .btn-row .btn {
                margin: 0;
            }
            /* åœ–ç‰‡ç·¨è¼¯ */
            .img-container {
                width: 100%;
                height: 50vh;
                background: #333;
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 10px;
            }
            .img-container img {
                max-width: 100%;
                display: block;
            }
            .canvas-wrapper {
                width: 100%;
                border: 2px solid #ddd;
                border-radius: 8px;
                background: #fff;
                margin-bottom: 10px;
                display: flex;
                justify-content: center;
                overflow: hidden;
            }
            .controls-panel {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 10px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            .control-item {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 14px;
            }
            input[type="color"] {
                border: none;
                width: 40px;
                height: 35px;
                cursor: pointer;
                background: none;
            }
            input[type="range"] {
                width: 80px;
            }
            #status {
                text-align: center;
                font-weight: bold;
                padding: 10px;
                color: #666;
            }
        </style>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
        />
    </head>
    <body>
        <div class="container">
            <!-- é¦–é  -->
            <div id="page-home">
                <h1>ğŸ“± æ‰‹æ©ŸåŠ©æ‰‹</h1>
                <p class="project-name" id="project-name">è¼‰å…¥ä¸­...</p>
                <div class="card">
                    <button class="menu-btn" onclick="showPage('overview')">
                        <span class="icon">ğŸ“·</span>
                        <span class="text"
                            >ç¸½è¦½ç…§ç‰‡<br /><small style="color: #888"
                                >UAV / GCS å…­é¢ç…§</small
                            ></span
                        >
                        <span class="arrow">â€º</span>
                    </button>
                    <button class="menu-btn" onclick="showPage('items')">
                        <span class="icon">ğŸ“‹</span>
                        <span class="text"
                            >æ¸¬é …ä½è­‰<br /><small style="color: #888"
                                >æª¢æ¸¬é …ç›®é™„ä»¶</small
                            ></span
                        >
                        <span class="arrow">â€º</span>
                    </button>
                </div>
            </div>

            <!-- ç¸½è¦½ç…§ç‰‡é  -->
            <div id="page-overview" class="hidden">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('home'); return false;"
                    >â† è¿”å›</a
                >
                <h1>ğŸ“· ç¸½è¦½ç…§ç‰‡</h1>
                <div class="card">
                    <div class="form-group">
                        <label>é¸æ“‡ç›®æ¨™</label>
                        <select id="overview-target">
                            <option value="UAV">UAV (ç„¡äººæ©Ÿ)</option>
                            <option value="GCS">GCS (åœ°é¢ç«™)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¸æ“‡è¦–è§’</label>
                        <select id="overview-angle">
                            <option value="front">æ­£é¢ (Front)</option>
                            <option value="back">èƒŒé¢ (Back)</option>
                            <option value="side1">å´é¢1 (Side 1)</option>
                            <option value="side2">å´é¢2 (Side 2)</option>
                            <option value="top">ä¸Šæ–¹ (Top)</option>
                            <option value="bottom">ä¸‹æ–¹ (Bottom)</option>
                        </select>
                    </div>
                    <input
                        type="file"
                        id="overview-file"
                        accept="image/*"
                        style="display: none"
                        onchange="onOverviewFileSelected(event)"
                    />
                    <button
                        class="btn btn-primary"
                        onclick="document.getElementById('overview-file').click()"
                    >
                        ğŸ“· æ‹ç…§æˆ–é¸å–ç…§ç‰‡
                    </button>
                </div>
            </div>

            <!-- æ¸¬é …åˆ—è¡¨é  -->
            <div id="page-items" class="hidden">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('home'); return false;"
                    >â† è¿”å›</a
                >
                <h1>ğŸ“‹ æ¸¬é …ä½è­‰</h1>
                <div class="card">
                    <ul class="item-list" id="item-list">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <!-- ä¸Šå‚³é ï¼ˆæ¸¬é …ä½è­‰ï¼‰ -->
            <div id="page-upload" class="hidden">
                <a
                    href="#"
                    class="back-btn"
                    onclick="showPage('items'); return false;"
                    >â† è¿”å›æ¸¬é …åˆ—è¡¨</a
                >
                <div class="card">
                    <div class="upload-header">
                        <h3 id="upload-item-name">æ¸¬é …åç¨±</h3>
                        <div class="subtitle" id="upload-item-id">ID</div>
                    </div>

                    <!-- Step 0: é¸æ“‡ -->
                    <div id="upload-step0">
                        <div class="form-group" id="target-select-group">
                            <label>é¸æ“‡ç›®æ¨™</label>
                            <select id="upload-target">
                                <option value="UAV">UAV</option>
                                <option value="GCS">GCS</option>
                                <option value="Shared">å…±ç”¨</option>
                            </select>
                        </div>
                        <input
                            type="file"
                            id="upload-file"
                            accept="image/*"
                            style="display: none"
                            onchange="onUploadFileSelected(event)"
                        />
                        <button
                            class="btn btn-primary"
                            onclick="document.getElementById('upload-file').click()"
                        >
                            ğŸ“· æ‹ç…§æˆ–é¸å–ç…§ç‰‡
                        </button>
                    </div>

                    <!-- Step 1: è£å‰ª -->
                    <div id="upload-step1" class="hidden">
                        <div class="img-container">
                            <img id="image-to-crop" src="" />
                        </div>
                        <div class="btn-row">
                            <button
                                class="btn btn-secondary"
                                onclick="resetUpload()"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                class="btn btn-primary"
                                onclick="finishCrop()"
                            >
                                ä¸‹ä¸€æ­¥ â¡ï¸
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: æ¨™è¨˜ -->
                    <div id="upload-step2" class="hidden">
                        <div class="form-group">
                            <label>åœ–ç‰‡æ¨™é¡Œ</label>
                            <input
                                type="text"
                                id="upload-title"
                                placeholder="è¼¸å…¥æ¨™é¡Œï¼ˆé¸å¡«ï¼‰"
                            />
                        </div>
                        <div class="controls-panel">
                            <div class="control-item">
                                é¡è‰²:
                                <input
                                    type="color"
                                    id="line-color"
                                    value="#ff0000"
                                />
                            </div>
                            <div class="control-item">
                                ç²—ç´°:
                                <input
                                    type="range"
                                    id="line-width"
                                    min="1"
                                    max="15"
                                    value="5"
                                /><span id="width-val">5</span>
                            </div>
                        </div>
                        <div class="canvas-wrapper">
                            <canvas id="fabric-canvas"></canvas>
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-danger" onclick="addRect()">
                                + æ¡†ç·š
                            </button>
                            <button
                                class="btn btn-secondary"
                                onclick="removeActiveObject()"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                        <div id="status"></div>
                        <div class="btn-row" style="margin-top: 15px">
                            <button
                                class="btn btn-secondary"
                                onclick="backToCrop()"
                            >
                                â¬…ï¸ é‡è£
                            </button>
                            <button
                                class="btn btn-success"
                                id="btn-upload"
                                onclick="doUpload()"
                            >
                                â˜ï¸ ä¸Šå‚³
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loading" class="hidden">è¼‰å…¥ä¸­...</div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
        <script>
            // å…¨åŸŸè®Šæ•¸
            let projectData = null;
            let currentItem = null;
            let cropper = null;
            let fabricCanvas = null;
            let originalImageWidth = 0;
            let uploadMode = "item"; // 'item' or 'overview'

            // åˆå§‹åŒ–
            async function init() {
                try {
                    const res = await fetch("/api/project");
                    projectData = await res.json();
                    document.getElementById("project-name").innerText =
                        projectData.name || "æœªå‘½åå°ˆæ¡ˆ";
                    renderItemList();
                } catch (e) {
                    document.getElementById("project-name").innerText =
                        "é€£ç·šå¤±æ•—";
                    console.error(e);
                }
            }

            // é é¢åˆ‡æ›
            function showPage(page) {
                document
                    .querySelectorAll('[id^="page-"]')
                    .forEach((el) => el.classList.add("hidden"));
                document
                    .getElementById("page-" + page)
                    .classList.remove("hidden");
            }

            // æ¸²æŸ“æ¸¬é …åˆ—è¡¨
            function renderItemList() {
                const list = document.getElementById("item-list");
                if (
                    !projectData ||
                    !projectData.items ||
                    projectData.items.length === 0
                ) {
                    list.innerHTML = "<li>æ²’æœ‰æ¸¬é …</li>";
                    return;
                }
                list.innerHTML = projectData.items
                    .map(
                        (item) => `
                <li onclick="selectItem('${item.uid}')">
                    <span class="item-id">${item.id}</span>
                    <span class="item-name">${item.name}</span>
                    <span class="arrow">â€º</span>
                </li>
            `
                    )
                    .join("");
            }

            // é¸æ“‡æ¸¬é …
            function selectItem(uid) {
                currentItem = projectData.items.find((i) => i.uid === uid);
                if (!currentItem) return;

                document.getElementById("upload-item-name").innerText =
                    currentItem.name;
                document.getElementById("upload-item-id").innerText =
                    currentItem.id;

                // è¨­å®šç›®æ¨™é¸æ“‡
                const targetSelect = document.getElementById("upload-target");
                const targetGroup = document.getElementById(
                    "target-select-group"
                );
                if (currentItem.targets && currentItem.targets.length > 1) {
                    targetGroup.classList.remove("hidden");
                    targetSelect.innerHTML =
                        currentItem.targets
                            .map((t) => `<option value="${t}">${t}</option>`)
                            .join("") + '<option value="Shared">å…±ç”¨</option>';
                } else {
                    targetGroup.classList.add("hidden");
                }

                uploadMode = "item";
                resetUpload();
                showPage("upload");
            }

            // ç¸½è¦½ç…§ç‰‡é¸æ“‡
            function onOverviewFileSelected(e) {
                uploadMode = "overview";
                currentItem = {
                    id: document.getElementById("overview-target").value,
                    name:
                        document.getElementById("overview-target").value +
                        " ç…§ç‰‡",
                    uid: "overview",
                    targets: [document.getElementById("overview-target").value],
                };

                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        document.getElementById("image-to-crop").src =
                            evt.target.result;
                        document.getElementById("upload-item-name").innerText =
                            currentItem.name;
                        document.getElementById("upload-item-id").innerText =
                            document.getElementById("overview-angle").value;
                        document
                            .getElementById("target-select-group")
                            .classList.add("hidden");
                        showPage("upload");
                        startCropMode();
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = "";
            }

            // æ¸¬é …ä¸Šå‚³é¸æ“‡
            function onUploadFileSelected(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        document.getElementById("image-to-crop").src =
                            evt.target.result;
                        startCropMode();
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = "";
            }

            // è£å‰ªæ¨¡å¼
            function startCropMode() {
                document.getElementById("upload-step0").classList.add("hidden");
                document
                    .getElementById("upload-step1")
                    .classList.remove("hidden");
                document.getElementById("upload-step2").classList.add("hidden");

                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(
                        document.getElementById("image-to-crop"),
                        {
                            viewMode: 1,
                            dragMode: "move",
                            autoCropArea: 0.9,
                            restore: false,
                            guides: true,
                            center: true,
                            highlight: false,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                        }
                    );
                }, 100);
            }

            // å®Œæˆè£å‰ª
            function finishCrop() {
                if (!cropper) return;
                const croppedCanvas = cropper.getCroppedCanvas({
                    maxWidth: 4096,
                    maxHeight: 4096,
                    imageSmoothingQuality: "high",
                });
                if (!croppedCanvas) {
                    alert("è£åˆ‡å¤±æ•—");
                    return;
                }
                originalImageWidth = croppedCanvas.width;
                startDrawMode(
                    croppedCanvas.toDataURL("image/jpeg", 0.95),
                    croppedCanvas.width,
                    croppedCanvas.height
                );
            }

            // æ¨™è¨˜æ¨¡å¼
            let croppedImageData = null; // å„²å­˜è£åˆ‡å¾Œçš„åœ–ç‰‡

            function startDrawMode(imageURL, w, h) {
                croppedImageData = imageURL; // ä¿å­˜åœ–ç‰‡æ•¸æ“š

                document.getElementById("upload-step1").classList.add("hidden");
                document
                    .getElementById("upload-step2")
                    .classList.remove("hidden");

                // ç­‰å¾…ä¸€ä¸‹ç¢ºä¿ DOM æ›´æ–°
                setTimeout(() => {
                    const container =
                        document.querySelector("#page-upload .card");
                    const containerWidth = container.clientWidth - 44;
                    const scaleFactor = containerWidth / w;
                    const finalWidth = containerWidth;
                    const finalHeight = h * scaleFactor;

                    if (fabricCanvas) {
                        fabricCanvas.dispose();
                        fabricCanvas = null;
                    }

                    const canvasEl = document.getElementById("fabric-canvas");

                    // å…ˆå»ºç«‹ canvas
                    fabricCanvas = new fabric.Canvas("fabric-canvas", {
                        width: finalWidth,
                        height: finalHeight,
                        selection: false,
                    });

                    // ä½¿ç”¨ Image ç‰©ä»¶è¼‰å…¥
                    const imgObj = new Image();
                    imgObj.onload = function () {
                        const fabricImg = new fabric.Image(imgObj, {
                            originX: "left",
                            originY: "top",
                            scaleX: scaleFactor,
                            scaleY: scaleFactor,
                            selectable: false,
                        });
                        fabricCanvas.setBackgroundImage(fabricImg, () => {
                            fabricCanvas.renderAll();
                        });
                    };
                    imgObj.src = imageURL;

                    fabricCanvas.on("selection:created", syncControls);
                    fabricCanvas.on("selection:updated", syncControls);
                }, 50);
            }

            // æ¡†ç·šæ§åˆ¶
            const colorInput = document.getElementById("line-color");
            const widthInput = document.getElementById("line-width");
            const widthVal = document.getElementById("width-val");

            widthInput.addEventListener("input", function () {
                widthVal.innerText = this.value;
                updateActiveObject();
            });
            colorInput.addEventListener("input", updateActiveObject);

            function updateActiveObject() {
                if (!fabricCanvas) return;
                const obj = fabricCanvas.getActiveObject();
                if (obj) {
                    obj.set({
                        stroke: colorInput.value,
                        strokeWidth: parseInt(widthInput.value, 10),
                    });
                    fabricCanvas.requestRenderAll();
                }
            }

            function syncControls(e) {
                const obj = e.selected[0];
                if (obj) {
                    colorInput.value = obj.stroke || "#ff0000";
                    widthInput.value = obj.strokeWidth || 5;
                    widthVal.innerText = obj.strokeWidth || 5;
                }
            }

            function addRect() {
                if (!fabricCanvas) return;
                const rect = new fabric.Rect({
                    left: fabricCanvas.width / 4,
                    top: fabricCanvas.height / 4,
                    width: fabricCanvas.width / 3,
                    height: fabricCanvas.height / 3,
                    fill: "transparent",
                    stroke: colorInput.value,
                    strokeWidth: parseInt(widthInput.value, 10),
                    cornerColor: "blue",
                    cornerSize: 20,
                    transparentCorners: false,
                    strokeUniform: true,
                });
                fabricCanvas.add(rect);
                fabricCanvas.setActiveObject(rect);
            }

            function removeActiveObject() {
                const obj = fabricCanvas.getActiveObject();
                if (obj) fabricCanvas.remove(obj);
            }

            function backToCrop() {
                document.getElementById("upload-step2").classList.add("hidden");
                document
                    .getElementById("upload-step1")
                    .classList.remove("hidden");
            }

            function resetUpload() {
                document
                    .getElementById("upload-step0")
                    .classList.remove("hidden");
                document.getElementById("upload-step1").classList.add("hidden");
                document.getElementById("upload-step2").classList.add("hidden");
                document.getElementById("upload-title").value = "";
                document.getElementById("status").innerText = "";
                document.getElementById("btn-upload").disabled = false;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }

            // ä¸Šå‚³
            async function doUpload() {
                if (!fabricCanvas) return;
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();

                const multiplier = originalImageWidth / fabricCanvas.getWidth();
                const dataURL = fabricCanvas.toDataURL({
                    format: "jpeg",
                    quality: 1.0,
                    multiplier: multiplier,
                });

                document.getElementById("status").innerText = "ä¸Šå‚³ä¸­...";
                document.getElementById("btn-upload").disabled = true;

                const blob = dataURLtoBlob(dataURL);
                const formData = new FormData();
                formData.append("photo", blob, "upload.jpg");
                formData.append(
                    "title",
                    document.getElementById("upload-title").value || ""
                );

                if (uploadMode === "overview") {
                    formData.append("mode", "overview");
                    const targetVal =
                        document.getElementById("overview-target").value;
                    const angleVal =
                        document.getElementById("overview-angle").value;
                    // è‡ªå‹•ç”¢ç”Ÿæ¨™é¡Œï¼šä¾‹å¦‚ "UAV æ­£é¢"
                    const angleNames = {
                        front: "æ­£é¢",
                        back: "èƒŒé¢",
                        side1: "å´é¢1",
                        side2: "å´é¢2",
                        top: "ä¸Šæ–¹",
                        bottom: "ä¸‹æ–¹",
                    };
                    const autoTitle =
                        targetVal + " " + (angleNames[angleVal] || angleVal);
                    formData.set("title", autoTitle);
                    formData.append("target", targetVal);
                    formData.append("angle", angleVal);
                } else {
                    formData.append("mode", "item");
                    formData.append("item_uid", currentItem.uid);
                    formData.append("item_id", currentItem.id);
                    formData.append("item_name", currentItem.name);
                    formData.append(
                        "target",
                        document.getElementById("upload-target").value
                    );
                }

                try {
                    const res = await fetch("/api/upload", {
                        method: "POST",
                        body: formData,
                    });
                    const data = await res.json();
                    if (data.status === "success") {
                        document.getElementById("status").innerText =
                            "âœ… ä¸Šå‚³æˆåŠŸ";
                        document.getElementById("status").style.color = "green";
                        setTimeout(() => {
                            alert("ä¸Šå‚³æˆåŠŸï¼");
                            resetUpload();
                            if (uploadMode === "overview") {
                                showPage("overview");
                            }
                        }, 500);
                    } else {
                        alert("å¤±æ•—: " + data.message);
                        document.getElementById("status").innerText = "";
                        document.getElementById("btn-upload").disabled = false;
                    }
                } catch (e) {
                    alert("ç¶²è·¯éŒ¯èª¤");
                    document.getElementById("status").innerText = "";
                    document.getElementById("btn-upload").disabled = false;
                }
            }

            function dataURLtoBlob(dataurl) {
                const arr = dataurl.split(",");
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) u8arr[n] = bstr.charCodeAt(n);
                return new Blob([u8arr], { type: mime });
            }

            // å•Ÿå‹•
            init();
        </script>
    </body>
</html>
